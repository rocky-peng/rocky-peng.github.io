const n=JSON.parse('{"key":"v-4519e68e","path":"/other/Spring%20Cloud%20Gateway%E6%94%B6%E5%88%B0%E7%9A%84%E6%98%AFhttp%E8%AF%B7%E6%B1%82%EF%BC%8C%E4%BD%86schema%E5%8D%B4%E6%98%AFhttps.html","title":"Spring Cloud Gateway收到的是http请求，但schema却是https","lang":"zh-CN","frontmatter":{"title":"Spring Cloud Gateway收到的是http请求，但schema却是https","date":"2025-05-18T00:00:00.000Z","description":"问题描述 为了方便说明问题，这里把问题简化下（实际上通过下面简化后的描述就暗示了是部署环境导致的问题，实际情况并没有这么顺利，中间经历过崩溃、搞不懂、超出认知、持续折腾了一周，各种实验、怀疑过这种问题，比如ingress自动申请的证书问题、ingress没有正确终止ssl，甚至还重新装过k3s，也怀疑过事traefix nginx的问题，哎，反正各种问题都怀疑完了，然后各种验证，崩溃完了） 有个nginx，跑了一个前端代码，配置文件大概这样： server { listen 80; listen 443 ssl http2; server_name xxxxx.top; index index.php index.html index.htm default.php default.htm default.html; root /www/wwwroot/xxxxx.top; #SSL-START SSL相关配置，请勿删除或修改下一行带注释的404规则 #error_page 404/404.html; #HTTP_TO_HTTPS_START if ($server_port !~ 443){ rewrite ^(/.*)$ https://$host$1 permanent; } #HTTP_TO_HTTPS_END #ssl_certificate /etc/letsencrypt/live/leyong.top/fullchain.pem; #ssl_certificate_key /etc/letsencrypt/live/leyong.top/privkey.pem; ssl_certificate /root/.acme.sh/xxxxx.top/fullchain.cer; ssl_certificate_key /root/.acme.sh/xxxxx.top/leyong.top.key; ssl_protocols TLSv1.1 TLSv1.2 TLSv1.3; ssl_ciphers EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5; ssl_prefer_server_ciphers on; ssl_session_cache shared:SSL:10m; ssl_session_timeout 10m; add_header Strict-Transport-Security \\"max-age=31536000\\"; error_page 497 https://$host$request_uri; \\t\\t#SSL-END #ERROR-PAGE-START 错误页配置，可以注释、删除或修改 #error_page 404 /404.html; #error_page 502 /502.html; #ERROR-PAGE-END #PHP-INFO-START PHP引用配置，可以注释或修改 include enable-php-00.conf; #PHP-INFO-END #REWRITE-START URL重写规则引用,修改后将导致面板设置的伪静态规则失效 include /www/server/panel/vhost/rewrite/xxxxx.top.conf; #REWRITE-END #禁止访问的文件或目录 location ~ ^/(\\\\.user.ini|\\\\.htaccess|\\\\.git|\\\\.env|\\\\.svn|\\\\.project|LICENSE|README.md) { return 404; } #一键申请SSL证书验证目录相关设置 location ~ \\\\.well-known{ allow all; } #禁止在证书验证目录放入敏感文件 if ( $uri ~ \\"^/\\\\.well-known/.*\\\\.(php|jsp|py|js|css|lua|ts|go|zip|tar\\\\.gz|rar|7z|sql|bak)$\\" ) { return 403; } location ^~ /ly { root /www/wwwroot/xxxxx.top; try_files $uri /ly/index.html; index index.html index.htm; error_page 405 =200\\thttp://$host:$server_port$request_uri; error_page 404 = /404.html; } location /api { proxy_set_header Host $host:$server_port; proxy_redirect off; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_connect_timeout 60; proxy_read_timeout 600; proxy_send_timeout 600; proxy_pass http://10.1.12.7:8760/api; #proxy_pass http://10.1.12.7:31760/api; client_max_body_size 80m; } access_log /www/wwwlogs/xxxxx.top.log; error_log /www/wwwlogs/xxxxx.top.error.log; }","head":[["link",{"rel":"canonical","href":"https://justsoso.fun/other/Spring%20Cloud%20Gateway%E6%94%B6%E5%88%B0%E7%9A%84%E6%98%AFhttp%E8%AF%B7%E6%B1%82%EF%BC%8C%E4%BD%86schema%E5%8D%B4%E6%98%AFhttps.html"}],["meta",{"property":"og:url","content":"https://justsoso.fun/other/Spring%20Cloud%20Gateway%E6%94%B6%E5%88%B0%E7%9A%84%E6%98%AFhttp%E8%AF%B7%E6%B1%82%EF%BC%8C%E4%BD%86schema%E5%8D%B4%E6%98%AFhttps.html"}],["meta",{"property":"og:site_name","content":"技术加油站"}],["meta",{"property":"og:title","content":"Spring Cloud Gateway收到的是http请求，但schema却是https"}],["meta",{"property":"og:description","content":"问题描述 为了方便说明问题，这里把问题简化下（实际上通过下面简化后的描述就暗示了是部署环境导致的问题，实际情况并没有这么顺利，中间经历过崩溃、搞不懂、超出认知、持续折腾了一周，各种实验、怀疑过这种问题，比如ingress自动申请的证书问题、ingress没有正确终止ssl，甚至还重新装过k3s，也怀疑过事traefix nginx的问题，哎，反正各种问题都怀疑完了，然后各种验证，崩溃完了） 有个nginx，跑了一个前端代码，配置文件大概这样： server { listen 80; listen 443 ssl http2; server_name xxxxx.top; index index.php index.html index.htm default.php default.htm default.html; root /www/wwwroot/xxxxx.top; #SSL-START SSL相关配置，请勿删除或修改下一行带注释的404规则 #error_page 404/404.html; #HTTP_TO_HTTPS_START if ($server_port !~ 443){ rewrite ^(/.*)$ https://$host$1 permanent; } #HTTP_TO_HTTPS_END #ssl_certificate /etc/letsencrypt/live/leyong.top/fullchain.pem; #ssl_certificate_key /etc/letsencrypt/live/leyong.top/privkey.pem; ssl_certificate /root/.acme.sh/xxxxx.top/fullchain.cer; ssl_certificate_key /root/.acme.sh/xxxxx.top/leyong.top.key; ssl_protocols TLSv1.1 TLSv1.2 TLSv1.3; ssl_ciphers EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5; ssl_prefer_server_ciphers on; ssl_session_cache shared:SSL:10m; ssl_session_timeout 10m; add_header Strict-Transport-Security \\"max-age=31536000\\"; error_page 497 https://$host$request_uri; \\t\\t#SSL-END #ERROR-PAGE-START 错误页配置，可以注释、删除或修改 #error_page 404 /404.html; #error_page 502 /502.html; #ERROR-PAGE-END #PHP-INFO-START PHP引用配置，可以注释或修改 include enable-php-00.conf; #PHP-INFO-END #REWRITE-START URL重写规则引用,修改后将导致面板设置的伪静态规则失效 include /www/server/panel/vhost/rewrite/xxxxx.top.conf; #REWRITE-END #禁止访问的文件或目录 location ~ ^/(\\\\.user.ini|\\\\.htaccess|\\\\.git|\\\\.env|\\\\.svn|\\\\.project|LICENSE|README.md) { return 404; } #一键申请SSL证书验证目录相关设置 location ~ \\\\.well-known{ allow all; } #禁止在证书验证目录放入敏感文件 if ( $uri ~ \\"^/\\\\.well-known/.*\\\\.(php|jsp|py|js|css|lua|ts|go|zip|tar\\\\.gz|rar|7z|sql|bak)$\\" ) { return 403; } location ^~ /ly { root /www/wwwroot/xxxxx.top; try_files $uri /ly/index.html; index index.html index.htm; error_page 405 =200\\thttp://$host:$server_port$request_uri; error_page 404 = /404.html; } location /api { proxy_set_header Host $host:$server_port; proxy_redirect off; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_connect_timeout 60; proxy_read_timeout 600; proxy_send_timeout 600; proxy_pass http://10.1.12.7:8760/api; #proxy_pass http://10.1.12.7:31760/api; client_max_body_size 80m; } access_log /www/wwwlogs/xxxxx.top.log; error_log /www/wwwlogs/xxxxx.top.error.log; }"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-05-23T15:20:25.000Z"}],["meta",{"property":"article:published_time","content":"2025-05-18T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2025-05-23T15:20:25.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Spring Cloud Gateway收到的是http请求，但schema却是https\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2025-05-18T00:00:00.000Z\\",\\"dateModified\\":\\"2025-05-23T15:20:25.000Z\\",\\"author\\":[]}"]]},"headers":[{"level":2,"title":"问题描述","slug":"问题描述","link":"#问题描述","children":[]},{"level":2,"title":"排查过程","slug":"排查过程","link":"#排查过程","children":[]},{"level":2,"title":"罪魁祸首","slug":"罪魁祸首","link":"#罪魁祸首","children":[]},{"level":2,"title":"系统推荐","slug":"系统推荐","link":"#系统推荐","children":[]}],"git":{"createdTime":1747588583000,"updatedTime":1748013625000,"contributors":[{"name":"rocky-peng","email":"rocky.peng@qq.com","commits":25}]},"readingTime":{"minutes":9.96,"words":2987},"filePathRelative":"other/Spring Cloud Gateway收到的是http请求，但schema却是https.md","localizedDate":"2025年5月18日","excerpt":"<h2> 问题描述</h2>\\n<p>为了方便说明问题，这里把问题简化下（实际上通过下面简化后的描述就暗示了是部署环境导致的问题，实际情况并没有这么顺利，<strong>中间经历过崩溃、搞不懂、超出认知、持续折腾了一周，各种实验、怀疑过这种问题，比如ingress自动申请的证书问题、ingress没有正确终止ssl，甚至还重新装过k3s，也怀疑过事traefix nginx的问题，哎，反正各种问题都怀疑完了，然后各种验证，崩溃完了</strong>）</p>\\n<p>有个nginx，跑了一个前端代码，配置文件大概这样：</p>\\n<div class=\\"language-bash line-numbers-mode\\" data-ext=\\"sh\\"><pre class=\\"language-bash\\"><code>server\\n<span class=\\"token punctuation\\">{</span>\\n    listen <span class=\\"token number\\">80</span><span class=\\"token punctuation\\">;</span>\\n    listen <span class=\\"token number\\">443</span> ssl  http2<span class=\\"token punctuation\\">;</span>\\n    server_name xxxxx.top<span class=\\"token punctuation\\">;</span>\\n    index index.php index.html index.htm default.php default.htm default.html<span class=\\"token punctuation\\">;</span>\\n    root /www/wwwroot/xxxxx.top<span class=\\"token punctuation\\">;</span>\\n\\n    <span class=\\"token comment\\">#SSL-START SSL相关配置，请勿删除或修改下一行带注释的404规则</span>\\n    <span class=\\"token comment\\">#error_page 404/404.html;</span>\\n    <span class=\\"token comment\\">#HTTP_TO_HTTPS_START</span>\\n    <span class=\\"token keyword\\">if</span> <span class=\\"token punctuation\\">(</span><span class=\\"token variable\\">$server_port</span> <span class=\\"token operator\\">!</span>~ <span class=\\"token number\\">443</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">{</span>\\n        rewrite ^<span class=\\"token punctuation\\">(</span>/.*<span class=\\"token punctuation\\">)</span>$ https://<span class=\\"token variable\\">$host</span><span class=\\"token variable\\">$1</span> permanent<span class=\\"token punctuation\\">;</span>\\n    <span class=\\"token punctuation\\">}</span>\\n    <span class=\\"token comment\\">#HTTP_TO_HTTPS_END</span>\\n    \\n    <span class=\\"token comment\\">#ssl_certificate    /etc/letsencrypt/live/leyong.top/fullchain.pem;</span>\\n    <span class=\\"token comment\\">#ssl_certificate_key    /etc/letsencrypt/live/leyong.top/privkey.pem;</span>\\n    \\n    ssl_certificate    /root/.acme.sh/xxxxx.top/fullchain.cer<span class=\\"token punctuation\\">;</span>\\n    ssl_certificate_key    /root/.acme.sh/xxxxx.top/leyong.top.key<span class=\\"token punctuation\\">;</span>\\n\\n    ssl_protocols TLSv1.1 TLSv1.2 TLSv1.3<span class=\\"token punctuation\\">;</span>\\n    ssl_ciphers EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:<span class=\\"token operator\\">!</span>MD5<span class=\\"token punctuation\\">;</span>\\n    ssl_prefer_server_ciphers on<span class=\\"token punctuation\\">;</span>\\n    ssl_session_cache shared:SSL:10m<span class=\\"token punctuation\\">;</span>\\n    ssl_session_timeout 10m<span class=\\"token punctuation\\">;</span>\\n    add_header Strict-Transport-Security <span class=\\"token string\\">\\"max-age=31536000\\"</span><span class=\\"token punctuation\\">;</span>\\n    error_page <span class=\\"token number\\">497</span>  https://<span class=\\"token variable\\">$host</span><span class=\\"token variable\\">$request_uri</span><span class=\\"token punctuation\\">;</span>\\n\\t\\t<span class=\\"token comment\\">#SSL-END</span>\\n\\n    <span class=\\"token comment\\">#ERROR-PAGE-START  错误页配置，可以注释、删除或修改</span>\\n    <span class=\\"token comment\\">#error_page 404 /404.html;</span>\\n    <span class=\\"token comment\\">#error_page 502 /502.html;</span>\\n    <span class=\\"token comment\\">#ERROR-PAGE-END</span>\\n\\n    <span class=\\"token comment\\">#PHP-INFO-START  PHP引用配置，可以注释或修改</span>\\n    include enable-php-00.conf<span class=\\"token punctuation\\">;</span>\\n    <span class=\\"token comment\\">#PHP-INFO-END</span>\\n\\n    <span class=\\"token comment\\">#REWRITE-START URL重写规则引用,修改后将导致面板设置的伪静态规则失效</span>\\n    include /www/server/panel/vhost/rewrite/xxxxx.top.conf<span class=\\"token punctuation\\">;</span>\\n    <span class=\\"token comment\\">#REWRITE-END</span>\\n\\n    <span class=\\"token comment\\">#禁止访问的文件或目录</span>\\n    location ~ ^/<span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">\\\\</span>.user.ini<span class=\\"token operator\\">|</span><span class=\\"token punctuation\\">\\\\</span>.htaccess<span class=\\"token operator\\">|</span><span class=\\"token punctuation\\">\\\\</span>.git<span class=\\"token operator\\">|</span><span class=\\"token punctuation\\">\\\\</span>.env<span class=\\"token operator\\">|</span><span class=\\"token punctuation\\">\\\\</span>.svn<span class=\\"token operator\\">|</span><span class=\\"token punctuation\\">\\\\</span>.project<span class=\\"token operator\\">|</span>LICENSE<span class=\\"token operator\\">|</span>README.md<span class=\\"token punctuation\\">)</span>\\n    <span class=\\"token punctuation\\">{</span>\\n        <span class=\\"token builtin class-name\\">return</span> <span class=\\"token number\\">404</span><span class=\\"token punctuation\\">;</span>\\n    <span class=\\"token punctuation\\">}</span>\\n\\n    <span class=\\"token comment\\">#一键申请SSL证书验证目录相关设置</span>\\n    location ~ <span class=\\"token punctuation\\">\\\\</span>.well-known<span class=\\"token punctuation\\">{</span>\\n        allow all<span class=\\"token punctuation\\">;</span>\\n    <span class=\\"token punctuation\\">}</span>\\n\\n    <span class=\\"token comment\\">#禁止在证书验证目录放入敏感文件</span>\\n    <span class=\\"token keyword\\">if</span> <span class=\\"token punctuation\\">(</span> <span class=\\"token variable\\">$uri</span> ~ <span class=\\"token string\\">\\"^/\\\\.well-known/.*\\\\.(php|jsp|py|js|css|lua|ts|go|zip|tar\\\\.gz|rar|7z|sql|bak)$\\"</span> <span class=\\"token punctuation\\">)</span> <span class=\\"token punctuation\\">{</span>\\n        <span class=\\"token builtin class-name\\">return</span> <span class=\\"token number\\">403</span><span class=\\"token punctuation\\">;</span>\\n    <span class=\\"token punctuation\\">}</span>\\n\\n    \\n    location ^~ /ly <span class=\\"token punctuation\\">{</span>\\n        root /www/wwwroot/xxxxx.top<span class=\\"token punctuation\\">;</span>\\n\\n        try_files <span class=\\"token variable\\">$uri</span> /ly/index.html<span class=\\"token punctuation\\">;</span>\\n        index  index.html index.htm<span class=\\"token punctuation\\">;</span>\\n        error_page <span class=\\"token number\\">405</span> <span class=\\"token operator\\">=</span><span class=\\"token number\\">200</span>\\thttp://<span class=\\"token variable\\">$host</span><span class=\\"token builtin class-name\\">:</span><span class=\\"token variable\\">$server_port</span><span class=\\"token variable\\">$request_uri</span><span class=\\"token punctuation\\">;</span>\\n        error_page <span class=\\"token number\\">404</span> <span class=\\"token operator\\">=</span> /404.html<span class=\\"token punctuation\\">;</span>\\n    <span class=\\"token punctuation\\">}</span>\\n    \\n    location /api <span class=\\"token punctuation\\">{</span>\\n        proxy_set_header   Host <span class=\\"token variable\\">$host</span><span class=\\"token builtin class-name\\">:</span><span class=\\"token variable\\">$server_port</span><span class=\\"token punctuation\\">;</span>\\n        proxy_redirect off<span class=\\"token punctuation\\">;</span>\\n        proxy_set_header X-Real-IP <span class=\\"token variable\\">$remote_addr</span><span class=\\"token punctuation\\">;</span>\\n        proxy_set_header X-Forwarded-For <span class=\\"token variable\\">$proxy_add_x_forwarded_for</span><span class=\\"token punctuation\\">;</span>\\n        proxy_connect_timeout <span class=\\"token number\\">60</span><span class=\\"token punctuation\\">;</span>\\n        proxy_read_timeout <span class=\\"token number\\">600</span><span class=\\"token punctuation\\">;</span>\\n        proxy_send_timeout <span class=\\"token number\\">600</span><span class=\\"token punctuation\\">;</span>\\n        proxy_pass http://10.1.12.7:8760/api<span class=\\"token punctuation\\">;</span>\\n        <span class=\\"token comment\\">#proxy_pass http://10.1.12.7:31760/api;</span>\\n        client_max_body_size 80m<span class=\\"token punctuation\\">;</span>\\n    <span class=\\"token punctuation\\">}</span>\\n    \\n    access_log  /www/wwwlogs/xxxxx.top.log<span class=\\"token punctuation\\">;</span>\\n    error_log  /www/wwwlogs/xxxxx.top.error.log<span class=\\"token punctuation\\">;</span>\\n<span class=\\"token punctuation\\">}</span>\\n\\n</code></pre><div class=\\"line-numbers\\" aria-hidden=\\"true\\"><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div></div></div>","copyright":{},"autoDesc":true}');export{n as data};
