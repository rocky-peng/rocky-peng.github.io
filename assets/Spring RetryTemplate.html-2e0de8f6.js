import{_ as c,$ as i,a0 as p,a1 as n,a2 as s,a3 as a,a4 as e,a5 as u,w as o}from"./framework-b3a0f150.js";const r={},d=u(`<p>使用spring的retry框架用两种方式，一种注解方式，一种代码方式，这里主要介绍代码编程方式。</p><p>初始化RetryTemplate主要有两个参数：</p><ol><li>RetryPolicy 主要定义什么情况要进行重试以及重试次数，比如超时、满足某个表达式。</li><li>BackoffPolicy 主要定义两次重试之间的等待时间。backoff这个单词在计算机系统中有很多地方都有，代表的意思基本相同，基本都是重试直接的等待时间。<strong>它的基本思想是在遇到错误时，不是立即重试，而是等待一段时间后再尝试。这种等待的时间通常是逐渐增加的，这就是所谓的“退避”</strong></li></ol><h2 id="retrypolicy" tabindex="-1"><a class="header-anchor" href="#retrypolicy" aria-hidden="true">#</a> RetryPolicy</h2><figure><img src="https://cdn.justdopay.top/notion/md5-19c6d975b35469503fc76e09db892242.png" alt="Untitled" tabindex="0" loading="lazy"><figcaption>Untitled</figcaption></figure><ul><li>SimpleRetryPolicy 默认最多重试3次</li><li>TimeoutRetryPolicy 默认在1秒内失败都会重试</li><li>ExpressionRetryPolicy 符合表达式就会重试</li><li>CircuitBreakerRetryPolicy 增加了熔断的机制，如果不在熔断状态，则允许重试</li><li>CompositeRetryPolicy 可以组合多个重试策略</li><li>NeverRetryPolicy 不重试</li><li>AlwaysRetryPolicy 一直重试</li></ul><h2 id="backoffpolicy" tabindex="-1"><a class="header-anchor" href="#backoffpolicy" aria-hidden="true">#</a> BackoffPolicy</h2><figure><img src="https://cdn.justdopay.top/notion/md5-614e14d24ffe43bce55b4322d1fb8d01.png" alt="Untitled" tabindex="0" loading="lazy"><figcaption>Untitled</figcaption></figure><ul><li>FixedBackOffPolicy 默认固定延迟1秒后执行下一次重试</li><li>ExponentialBackOffPolicy 指数递增延迟执行重试，默认初始0.1秒，系数是2，那么下次延迟0.2秒，再下次就是延迟0.4秒，如此类推，最大30秒。</li><li>ExponentialRandomBackOffPolicy 在上面那个策略上增加随机性</li><li>UniformRandomBackOffPolicy 这个跟上面的区别就是，上面的延迟会不停递增，这个只会在固定的区间随机</li><li>StatelessBackOffPolicy 这个说明是无状态的，所谓无状态就是对上次的退避无感知，从它下面的子类也能看出来</li></ul><p>个人比较喜欢实用 ExponentialBackOffPolicy</p><h2 id="示例" tabindex="-1"><a class="header-anchor" href="#示例" aria-hidden="true">#</a> 示例</h2><figure><img src="https://cdn.justdopay.top/notion/md5-9311b7ee9c5e11088a191a3662ca7f51.png" alt="Untitled" tabindex="0" loading="lazy"><figcaption>Untitled</figcaption></figure><div class="language-jsx line-numbers-mode" data-ext="jsx"><pre class="language-jsx"><code><span class="token keyword">private</span> <span class="token keyword">static</span> final RetryTemplate <span class="token constant">RETRY_TEMPLATE</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token punctuation">{</span>
    <span class="token comment">//重试时间间隔，分别是300ms,600ms,1200ms,依次翻倍，一直到最大时间间隔为3000ms</span>
    ExponentialBackOffPolicy backOffPolicy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExponentialBackOffPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    backOffPolicy<span class="token punctuation">.</span><span class="token function">setInitialInterval</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    backOffPolicy<span class="token punctuation">.</span><span class="token function">setMaxInterval</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token constant">RETRY_TEMPLATE</span> <span class="token operator">=</span> RetryTemplate<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">//当抛这些异常的时候进行重试</span>
            <span class="token punctuation">.</span><span class="token function">retryOn</span><span class="token punctuation">(</span>Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>RemoteAccessException<span class="token punctuation">.</span>class<span class="token punctuation">,</span> TimeoutException<span class="token punctuation">.</span>class<span class="token punctuation">,</span> NullPointerException<span class="token punctuation">.</span>class<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">//最大重试次数为4</span>
            <span class="token punctuation">.</span><span class="token function">maxAttempts</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
            <span class="token comment">//自定义重试时间间隔</span>
            <span class="token punctuation">.</span><span class="token function">customBackoff</span><span class="token punctuation">(</span>backOffPolicy<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> Object <span class="token function">httpRemoteCall</span><span class="token punctuation">(</span><span class="token parameter">Object<span class="token operator">...</span> params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    AtomicInteger retryCounter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">RETRY_TEMPLATE</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>ctx <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;第&quot;</span> <span class="token operator">+</span> retryCounter<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;次执行远程调用&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//在这里正常写远程调用的代码</span>

        <span class="token comment">//正常返回远程调用的结果</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="扩展" tabindex="-1"><a class="header-anchor" href="#扩展" aria-hidden="true">#</a> 扩展</h2>`,14),k={href:"https://github.com/spring-projects/spring-retry",target:"_blank",rel:"noopener noreferrer"},E=n("br",null,null,-1),m=n("h2",{id:"系统推荐",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#系统推荐","aria-hidden":"true"},"#"),s(" 系统推荐")],-1),f=n("p",null,[n("br"),n("br"),n("br"),n("br"),n("br"),n("br")],-1),h=n("hr",null,null,-1),b=n("hr",null,null,-1),B=n("ul",null,[n("li",null,[n("strong",null,"随机毒鸡汤"),s("：我悄悄努力，不是为了惊艳所有人，而是怕失败了被人知道。 "),n("br"),n("br"),n("img",{src:"https://images.pexels.com/photos/31248318/pexels-photo-31248318.jpeg?auto=compress&cs=tinysrgb&h=650&w=940",alt:"Fashionable woman in wide-brim hat holding coffee cup, enjoying sunny day on steps.",loading:"lazy"})])],-1);function y(v,A){const l=o("ExternalLinkIcon"),t=o("RouterLink");return i(),p("div",null,[d,n("p",null,[n("a",k,[s("https://github.com/spring-projects/spring-retry"),a(l)])]),E,m,n("ul",null,[n("li",null,[a(t,{to:"/other/Git%E5%90%88%E5%B9%B6%E5%A4%9A%E4%B8%AA%E6%8F%90%E4%BA%A4%E5%B9%B6push%E5%88%B0%E8%BF%9C%E7%A8%8B%E4%BB%93%E5%BA%93.html"},{default:e(()=>[s("Git合并多个提交并push到远程仓库")]),_:1})]),n("li",null,[a(t,{to:"/other/MySQL%E9%AB%98%E5%8F%AF%E7%94%A8.html"},{default:e(()=>[s("MySQL高可用")]),_:1})]),n("li",null,[a(t,{to:"/software/middleware/es/ES6.2.3(3%E8%8A%82%E7%82%B9)%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB%E5%88%B0ES7.4.1(5%E8%8A%82%E7%82%B9).html"},{default:e(()=>[s("ES6.2.3(3节点)数据迁移到ES7.4.1(5节点)")]),_:1})]),n("li",null,[a(t,{to:"/other/%E6%98%AF%E6%97%B6%E5%80%99%E4%BD%BF%E7%94%A8MapStruct%E6%9B%BF%E4%BB%A3BeanUtils%E4%BA%86.html"},{default:e(()=>[s("是时候使用MapStruct替代BeanUtils了")]),_:1})]),n("li",null,[a(t,{to:"/other/%E9%AB%98%E5%8F%AF%E7%94%A8%E9%80%9A%E7%94%A8%E6%96%B9%E6%A1%88.html"},{default:e(()=>[s("高可用通用方案")]),_:1})]),n("li",null,[a(t,{to:"/other/%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E6%96%B9%E6%A1%88.html"},{default:e(()=>[s("数据同步方案")]),_:1})]),n("li",null,[a(t,{to:"/software/unclassified/linux_no_space_left_on_device.html"},{default:e(()=>[s("linux_no_space_left_on_device")]),_:1})]),n("li",null,[a(t,{to:"/other/%E6%8E%A8%E8%8D%90%E5%87%A0%E4%B8%AA%E9%80%82%E7%94%A8%E5%B0%8F%E5%B7%A5%E5%85%B7.html"},{default:e(()=>[s("推荐几个适用小工具")]),_:1})]),n("li",null,[a(t,{to:"/software/java-basic/%E4%B8%8D%E9%87%8D%E5%90%AF%20JVM%EF%BC%8C%E5%A6%82%E4%BD%95%E6%9B%BF%E6%8D%A2%E6%8E%89%E5%B7%B2%E7%BB%8F%E5%8A%A0%E8%BD%BD%E7%9A%84%E7%B1%BB%EF%BC%9F.html"},{default:e(()=>[s("不重启 JVM，如何替换掉已经加载的类？")]),_:1})]),n("li",null,[a(t,{to:"/other/Lombok%E7%9A%84Accessors%E5%AF%BC%E8%87%B4EasyExcel%E8%AF%BB%E5%8F%96%E5%A4%B1%E8%B4%A5.html"},{default:e(()=>[s("Lombok的Accessors导致EasyExcel读取失败")]),_:1})]),n("li",null,[a(t,{to:"/software/raft/sofajraft.html"},{default:e(()=>[s("sofajraft")]),_:1})]),n("li",null,[a(t,{to:"/other/SpringBoot%E6%9C%8D%E5%8A%A1%E5%9C%A8%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8%E5%AE%8C%E6%88%90%E5%89%8D%E8%A2%AB%E6%8F%90%E5%89%8D%E6%B3%A8%E5%86%8C%E5%88%B0nacos.html"},{default:e(()=>[s("SpringBoot服务在服务启动完成前被提前注册到nacos")]),_:1})])]),f,h,b,B])}const g=c(r,[["render",y],["__file","Spring RetryTemplate.html.vue"]]);export{g as default};
