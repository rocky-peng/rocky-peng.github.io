import{_ as r,$ as o,a0 as l,a1 as e,a3 as t,a4 as n,a5 as s,a2 as i,w as p}from"./framework-58787b1c.js";const d={},c=s(`<h2 id="本地配置的情况" tabindex="-1"><a class="header-anchor" href="#本地配置的情况" aria-hidden="true">#</a> 本地配置的情况</h2><p>一般情况下，在开始一个新的项目的时候，可能我们多半会把配置信息写在工程目录下，使用不同的文件来配置不同环境下的配置。比如：</p><figure><img src="https://cdn.justdopay.com/xiaoshujiang/1629081604491.png" alt="不同环境的配置文件" tabindex="0" loading="lazy"><figcaption>不同环境的配置文件</figcaption></figure><p>然后在spring的配置文件会出现类似这样的配置：</p><figure><img src="https://cdn.justdopay.com/xiaoshujiang/1629081610453.png" alt="spring的配置" tabindex="0" loading="lazy"><figcaption>spring的配置</figcaption></figure><p>这样的处理有一个弊端，那就是一些系统的敏感信息也会写入在配置文件中，比如我们公司之前的配置：</p><figure><img src="https://cdn.justdopay.com/xiaoshujiang/1629081615827.png" alt="之前的配置" tabindex="0" loading="lazy"><figcaption>之前的配置</figcaption></figure><p>上面的诸如 alipayAppPrivateKey alipayAliPublicKey 这些敏感信息从安全角度不应该出现在配置文件中的，要知道有了这些信息是可以通过api进行转账操作的。于是如果有一个配置中心，我们只需要把配置信息放到配置中心里就可以解决这个问题了。</p><p>现在工业上有很多开源的配置中心，比如Apollo 、Spring Cloud Config等等，但由于本人所在公司资源精力有限，决定自己做一个简易版的配置服务。通过这个简易版的配置服务，我们也能窥探现在成熟的功能更加完善的配置中心是怎样的一个原理。</p><h2 id="整体设计" tabindex="-1"><a class="header-anchor" href="#整体设计" aria-hidden="true">#</a> 整体设计</h2><figure><img src="https://cdn.justdopay.com/xiaoshujiang/1629081624435.png" alt="enter description here" tabindex="0" loading="lazy"><figcaption>enter description here</figcaption></figure><p>业务服务器在启动的时候（其实不一定，这里为了简化只在启动的时候拉取）向配置服务器拉取配置信息，然后进行初始化等一系列操作。</p><p>交互的方式就是很普通的http接口（也可以设计为tcp等通信方式），具体设计如下：</p><p>请求参数</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>- appName ：应用的名字
- mode ：拉取什么环境的配置，比如local test prod
- appConfigSecret ：盐 ，主要为了安全性，可以周期性的更换这个
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>返回值： 这里返回值设置为string, string的格式为了方便看和兼容之前的配置，采用了properties文件的方式。业务服务器拉取配置后，进行对应格式的解析。</p><h2 id="配置服务器" tabindex="-1"><a class="header-anchor" href="#配置服务器" aria-hidden="true">#</a> 配置服务器</h2><p>配置信息的存储为了简单，也采用了mysql进行存储。这里就剔除了配置信息回滚的功能，只完成核心功能。 表结构如下：</p><figure><img src="https://cdn.justdopay.com/xiaoshujiang/1629081650313.png" alt="enter description here" tabindex="0" loading="lazy"><figcaption>enter description here</figcaption></figure><p>app_name + app_mode + app_config_secret 三个信息组合成一个联合唯一索引（字段长度也许不合理哈，这里就没有深究这个了），通过这三个信息来查询 app_config 字段的信息。app_config 字段的格式就是properties形式的字符串。</p><p>通过这三个字段读取配置信息的这个http接口就不用赘述了是吧（这个接口根据自身需要可以添加其他的一些安全策略）</p><p>写好接口后，发布到内网或者公网作为一个独立的服务即可。</p><h2 id="业务服务器" tabindex="-1"><a class="header-anchor" href="#业务服务器" aria-hidden="true">#</a> 业务服务器</h2><p>在这块我们的核心问题就是写代码去请求配置服务，拉取配置信息。</p><p>这里有个关键类：PropertyPlaceholderConfigurer ，我们只需要继承这个类，重写下 processProperties 或者其他方法即可。我这里就处理得很简单了，代码如下:</p><figure><img src="https://cdn.justdopay.com/xiaoshujiang/1629081792369.png" alt="enter description here" tabindex="0" loading="lazy"><figcaption>enter description here</figcaption></figure><figure><img src="https://cdn.justdopay.com/xiaoshujiang/1629081800286.png" alt="enter description here" tabindex="0" loading="lazy"><figcaption>enter description here</figcaption></figure><p>代码中可以看到，我这里还是对项目中的配置文件保留了一个基本的配置，也就是配置文件还是有，但只保留必要的几个配置，如下</p><figure><img src="https://cdn.justdopay.com/xiaoshujiang/1629081804949.png" alt="enter description here" tabindex="0" loading="lazy"><figcaption>enter description here</figcaption></figure><p>前面三个参数时配置服务需要的，第四个参数是指定配置服务器的host地址</p><p>剩下是日志相关的配置。</p><p>代码有了，下面就是更改spirng的配置： 把之前所有用到</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>&lt;util:properties id=&quot;config&quot; location=&quot;classpath:config.properties&quot;/&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>的地方都替换为：</p><figure><img src="https://cdn.justdopay.com/xiaoshujiang/1629081808721.png" alt="enter description here" tabindex="0" loading="lazy"><figcaption>enter description here</figcaption></figure><p>然后还需改一个地方，那就是把引用配置的地方改为<span class="katex-error" title="ParseError: KaTeX parse error: Expected &#39;EOF&#39;, got &#39;#&#39; at position 4: 形式（#̲和" style="color:#cc0000;"><span class="cjk_fallback">形式（#和</span></span>的区别，这里也不赘述了），如下图：</p><figure><img src="https://cdn.justdopay.com/xiaoshujiang/1629081811982.png" alt="之前的写法" tabindex="0" loading="lazy"><figcaption>之前的写法</figcaption></figure><p>改为： <img src="https://cdn.justdopay.com/xiaoshujiang/1629081823564.png" alt="改后的写法" loading="lazy"></p><h2 id="万事俱备只欠东风" tabindex="-1"><a class="header-anchor" href="#万事俱备只欠东风" aria-hidden="true">#</a> 万事俱备只欠东风</h2><p>往配置服务的数据表里添加对应的配置信息，搞定。</p><p>感兴趣的朋友可以加微信群。</p><br><h2 id="系统推荐" tabindex="-1"><a class="header-anchor" href="#系统推荐" aria-hidden="true">#</a> 系统推荐</h2>`,43),u=e("p",null,[e("br"),e("br"),e("br"),e("br"),e("br"),e("br")],-1),g=e("hr",null,null,-1),E=e("hr",null,null,-1),h=e("ul",null,[e("li",null,[e("strong",null,"随机毒鸡汤"),i("：以前上学是拿钱混日子，现在工作了，是在拿日子混钱。 "),e("br"),e("br"),e("img",{src:"https://tuapi.eees.cc/api.php?category=biying&type=302&uuid=d8a22533-424e-4394-ab5b-f90c297bb3ac",alt:"",loading:"lazy"})])],-1);function f(A,m){const a=p("RouterLink");return o(),l("div",null,[c,e("ul",null,[e("li",null,[t(a,{to:"/software/unclassified/Git%E7%AC%94%E8%AE%B0.html"},{default:n(()=>[i("Git笔记")]),_:1})]),e("li",null,[t(a,{to:"/software/unclassified/RSA%20%E5%8A%A0%E5%AF%86%E8%A7%A3%E5%AF%86%E5%A4%9A%E8%AF%AD%E8%A8%80%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88.html"},{default:n(()=>[i("RSA 加密解密多语言实现方案")]),_:1})]),e("li",null,[t(a,{to:"/other/%E5%BE%AE%E5%8D%9A%E5%85%B3%E6%B3%A8%E5%85%B3%E7%B3%BB%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0.html"},{default:n(()=>[i("微博关注关系如何实现")]),_:1})]),e("li",null,[t(a,{to:"/other/CloudFlare%20%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%81%E4%B9%A6%E7%9A%84%E4%BD%BF%E7%94%A8.html"},{default:n(()=>[i("CloudFlare 客户端证书的使用")]),_:1})]),e("li",null,[t(a,{to:"/software/unclassified/%E6%B5%8B%E8%AF%95%E4%B8%A4%E5%8F%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%97%B4%E7%9A%84%E7%BD%91%E9%80%9F.html"},{default:n(()=>[i("测试两台服务器间的网速")]),_:1})]),e("li",null,[t(a,{to:"/software/shodowsocks/ShadowsockServerUpdatePort.html"},{default:n(()=>[i("ShadowsockServerUpdatePort")]),_:1})]),e("li",null,[t(a,{to:"/software/unclassified/%E6%89%B9%E9%87%8F%E4%BF%AE%E6%94%B9git%E5%8E%86%E5%8F%B2%E8%AE%B0%E5%BD%95%E4%B8%AD%E7%9A%84%E7%94%A8%E6%88%B7%E5%90%8D%E5%92%8C%E9%82%AE%E7%AE%B1.html"},{default:n(()=>[i("批量修改git历史记录中的用户名和邮箱")]),_:1})]),e("li",null,[t(a,{to:"/software/jvm/JVM%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86.html"},{default:n(()=>[i("JVM异常处理")]),_:1})]),e("li",null,[t(a,{to:"/other/PGSQL%E7%9A%84json%E5%92%8C%20jsonb%20%E8%AF%BB%E5%86%99%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95.html"},{default:n(()=>[i("PGSQL的json和 jsonb 读写性能测试")]),_:1})]),e("li",null,[t(a,{to:"/other/Git%E5%8E%86%E5%8F%B2%E8%AE%B0%E5%BD%95%E4%BF%AE%E6%94%B9%E7%94%A8%E6%88%B7%E5%90%8D%E5%92%8C%E9%82%AE%E7%AE%B1.html"},{default:n(()=>[i("Git历史记录修改用户名和邮箱")]),_:1})]),e("li",null,[t(a,{to:"/other/GitHub%20Workflow%E7%AA%81%E7%84%B6%E6%8A%A5%E9%94%99.html"},{default:n(()=>[i("GitHub Workflow突然报错")]),_:1})]),e("li",null,[t(a,{to:"/software/unclassified/BBR%E5%8A%A0%E9%80%9F.html"},{default:n(()=>[i("BBR加速")]),_:1})])]),u,g,E,h])}const B=r(d,[["render",f],["__file","简易版配置中心_初探原理.html.vue"]]);export{B as default};
