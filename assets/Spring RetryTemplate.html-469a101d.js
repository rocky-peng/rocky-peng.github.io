import{_ as i,$ as c,a0 as p,a1 as n,a2 as s,a3 as a,a4 as e,a5 as u,w as o}from"./framework-b6ede5bc.js";const r={},d=u(`<p>使用spring的retry框架用两种方式，一种注解方式，一种代码方式，这里主要介绍代码编程方式。</p><p>初始化RetryTemplate主要有两个参数：</p><ol><li>RetryPolicy 主要定义什么情况要进行重试以及重试次数，比如超时、满足某个表达式。</li><li>BackoffPolicy 主要定义两次重试之间的等待时间。backoff这个单词在计算机系统中有很多地方都有，代表的意思基本相同，基本都是重试直接的等待时间。<strong>它的基本思想是在遇到错误时，不是立即重试，而是等待一段时间后再尝试。这种等待的时间通常是逐渐增加的，这就是所谓的“退避”</strong></li></ol><h2 id="retrypolicy" tabindex="-1"><a class="header-anchor" href="#retrypolicy" aria-hidden="true">#</a> RetryPolicy</h2><figure><img src="https://cdn.justdopay.com/notion/md5-19c6d975b35469503fc76e09db892242.png" alt="Untitled" tabindex="0" loading="lazy"><figcaption>Untitled</figcaption></figure><ul><li>SimpleRetryPolicy 默认最多重试3次</li><li>TimeoutRetryPolicy 默认在1秒内失败都会重试</li><li>ExpressionRetryPolicy 符合表达式就会重试</li><li>CircuitBreakerRetryPolicy 增加了熔断的机制，如果不在熔断状态，则允许重试</li><li>CompositeRetryPolicy 可以组合多个重试策略</li><li>NeverRetryPolicy 不重试</li><li>AlwaysRetryPolicy 一直重试</li></ul><h2 id="backoffpolicy" tabindex="-1"><a class="header-anchor" href="#backoffpolicy" aria-hidden="true">#</a> BackoffPolicy</h2><figure><img src="https://cdn.justdopay.com/notion/md5-614e14d24ffe43bce55b4322d1fb8d01.png" alt="Untitled" tabindex="0" loading="lazy"><figcaption>Untitled</figcaption></figure><ul><li>FixedBackOffPolicy 默认固定延迟1秒后执行下一次重试</li><li>ExponentialBackOffPolicy 指数递增延迟执行重试，默认初始0.1秒，系数是2，那么下次延迟0.2秒，再下次就是延迟0.4秒，如此类推，最大30秒。</li><li>ExponentialRandomBackOffPolicy 在上面那个策略上增加随机性</li><li>UniformRandomBackOffPolicy 这个跟上面的区别就是，上面的延迟会不停递增，这个只会在固定的区间随机</li><li>StatelessBackOffPolicy 这个说明是无状态的，所谓无状态就是对上次的退避无感知，从它下面的子类也能看出来</li></ul><p>个人比较喜欢实用 ExponentialBackOffPolicy</p><h2 id="示例" tabindex="-1"><a class="header-anchor" href="#示例" aria-hidden="true">#</a> 示例</h2><figure><img src="https://cdn.justdopay.com/notion/md5-9311b7ee9c5e11088a191a3662ca7f51.png" alt="Untitled" tabindex="0" loading="lazy"><figcaption>Untitled</figcaption></figure><div class="language-jsx line-numbers-mode" data-ext="jsx"><pre class="language-jsx"><code><span class="token keyword">private</span> <span class="token keyword">static</span> final RetryTemplate <span class="token constant">RETRY_TEMPLATE</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token punctuation">{</span>
    <span class="token comment">//重试时间间隔，分别是300ms,600ms,1200ms,依次翻倍，一直到最大时间间隔为3000ms</span>
    ExponentialBackOffPolicy backOffPolicy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExponentialBackOffPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    backOffPolicy<span class="token punctuation">.</span><span class="token function">setInitialInterval</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    backOffPolicy<span class="token punctuation">.</span><span class="token function">setMaxInterval</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token constant">RETRY_TEMPLATE</span> <span class="token operator">=</span> RetryTemplate<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">//当抛这些异常的时候进行重试</span>
            <span class="token punctuation">.</span><span class="token function">retryOn</span><span class="token punctuation">(</span>Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>RemoteAccessException<span class="token punctuation">.</span>class<span class="token punctuation">,</span> TimeoutException<span class="token punctuation">.</span>class<span class="token punctuation">,</span> NullPointerException<span class="token punctuation">.</span>class<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">//最大重试次数为4</span>
            <span class="token punctuation">.</span><span class="token function">maxAttempts</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
            <span class="token comment">//自定义重试时间间隔</span>
            <span class="token punctuation">.</span><span class="token function">customBackoff</span><span class="token punctuation">(</span>backOffPolicy<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> Object <span class="token function">httpRemoteCall</span><span class="token punctuation">(</span><span class="token parameter">Object<span class="token operator">...</span> params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    AtomicInteger retryCounter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">RETRY_TEMPLATE</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>ctx <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;第&quot;</span> <span class="token operator">+</span> retryCounter<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;次执行远程调用&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//在这里正常写远程调用的代码</span>

        <span class="token comment">//正常返回远程调用的结果</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="扩展" tabindex="-1"><a class="header-anchor" href="#扩展" aria-hidden="true">#</a> 扩展</h2>`,14),k={href:"https://github.com/spring-projects/spring-retry",target:"_blank",rel:"noopener noreferrer"},m=n("br",null,null,-1),f=n("h2",{id:"系统推荐",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#系统推荐","aria-hidden":"true"},"#"),s(" 系统推荐")],-1),E=n("p",null,[n("br"),n("br"),n("br"),n("br"),n("br"),n("br")],-1),b=n("hr",null,null,-1),h=n("hr",null,null,-1),y=n("ul",null,[n("li",null,[n("strong",null,"随机毒鸡汤"),s("：人们认为，大脑是人体最聪明的器官，可这个判断是大脑做出来的。 "),n("br"),n("br"),n("img",{src:"https://tuapi.eees.cc/api.php?category=fengjing&type=302&uuid=bce52277-3a9f-4c3d-a14d-37d5ff38d996",alt:"",loading:"lazy"})])],-1);function v(A,g){const l=o("ExternalLinkIcon"),t=o("RouterLink");return c(),p("div",null,[d,n("p",null,[n("a",k,[s("https://github.com/spring-projects/spring-retry"),a(l)])]),m,f,n("ul",null,[n("li",null,[a(t,{to:"/software/unclassified/RSA%20%E5%8A%A0%E5%AF%86%E8%A7%A3%E5%AF%86%E5%A4%9A%E8%AF%AD%E8%A8%80%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88.html"},{default:e(()=>[s("RSA 加密解密多语言实现方案")]),_:1})]),n("li",null,[a(t,{to:"/software/unclassified/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F.html"},{default:e(()=>[s("记一次内存泄漏")]),_:1})]),n("li",null,[a(t,{to:"/software/spring/Spring%20Cloud%EF%BC%88%E4%B8%80%EF%BC%89%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E6%8A%80%E6%9C%AF%E6%A6%82%E8%A7%88%E3%80%90Finchley%20%E7%89%88%E3%80%91.html"},{default:e(()=>[s("Spring Cloud（一）：服务治理技术概览【Finchley 版】")]),_:1})]),n("li",null,[a(t,{to:"/other/PostgreSQL%E5%AE%9A%E6%97%B6%E5%A4%87%E4%BB%BD.html"},{default:e(()=>[s("PostgreSQL定时备份")]),_:1})]),n("li",null,[a(t,{to:"/other/Cornell%20Notes%20System.html"},{default:e(()=>[s("Cornell Notes System")]),_:1})]),n("li",null,[a(t,{to:"/software/shodowsocks/ShadowsockServerUpdatePort.html"},{default:e(()=>[s("ShadowsockServerUpdatePort")]),_:1})]),n("li",null,[a(t,{to:"/other/istio%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86.html"},{default:e(()=>[s("istio基础知识")]),_:1})]),n("li",null,[a(t,{to:"/other/Spring%20Boot%E5%8D%87%E7%BA%A7%E5%88%B02%206%20x%E8%B8%A9%E7%9A%84%E5%9D%91.html"},{default:e(()=>[s("Spring Boot升级到2 6 x踩的坑")]),_:1})]),n("li",null,[a(t,{to:"/software/middleware/mysql/MySQL%E4%B8%89%E5%A4%A7%E6%97%A5%E5%BF%97.html"},{default:e(()=>[s("MySQL三大日志")]),_:1})]),n("li",null,[a(t,{to:"/software/java-basic/Java%E9%9D%A2%E8%AF%95%E5%9F%BA%E7%A1%80.html"},{default:e(()=>[s("Java面试基础")]),_:1})]),n("li",null,[a(t,{to:"/software/unclassified/%E6%89%B9%E9%87%8F%E6%9B%BF%E6%8D%A2%E6%96%87%E4%BB%B6%E5%90%8D%E4%B8%AD%E7%9A%84%E6%8C%87%E5%AE%9A%E5%AD%97%E7%AC%A6%E4%B8%B2.html"},{default:e(()=>[s("批量替换文件名中的指定字符串")]),_:1})]),n("li",null,[a(t,{to:"/software/linux/Linux.html"},{default:e(()=>[s("Linux")]),_:1})])]),E,b,h,y])}const _=i(r,[["render",v],["__file","Spring RetryTemplate.html.vue"]]);export{_ as default};
