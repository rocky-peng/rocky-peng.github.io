import{_ as c,$ as i,a0 as u,a1 as n,a2 as s,a3 as a,a4 as t,a5 as o,w as p}from"./framework-b3a0f150.js";const r={},d=o(`<ol><li><p>top -p pid 看到某个进程占用的物理内存，以及创建的线程数，也可以通过Shift+f命令对指定列进行排序，从而找到异常线程的pid。然后可以通过jstack pid | grep 命令找到这个线程在做的事，从而进行排查。</p></li><li><p>ps axu | grep -E &#39;pid|USER&#39; 通过这个方式也能看到某个进程占用的物理内存，结果和top命令是匹配的。</p></li><li><p>-Xms300m -Xmx300m 同时设置了这两个参数并不代表jvm一启动就会向os申请300m的内存（是指不会立即占用300m内存）。同理，-XX:MaxPermSize=300m -XX: PermSize=300m也是一样的，也不会立即占用300m内存。 具体当前jvm instance占用了多少内存（这里值堆内内存），可以通过jmap -heap pid查看。</p></li><li><p>jmap -heap pid 这个命令能查看当前jvm各个堆区域使用情况，把各个区域使用空间累加便得到当前jvm程序占用了多少内存。注意是堆内内存，这个命令是不能看到jvm对堆外内存的使用情况的。比如：</p></li></ol><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>jmap <span class="token parameter variable">-heap</span> <span class="token number">3273</span>
Attaching to process ID <span class="token number">3273</span>, please wait<span class="token punctuation">..</span>.
Debugger attached successfully.
Server compiler detected.
JVM version is <span class="token number">24.80</span>-b11

using thread-local object allocation.
Parallel GC with <span class="token number">2</span> thread<span class="token punctuation">(</span>s<span class="token punctuation">)</span>

Heap Configuration:
   MinHeapFreeRatio <span class="token operator">=</span> <span class="token number">0</span>
   MaxHeapFreeRatio <span class="token operator">=</span> <span class="token number">100</span>
   MaxHeapSize      <span class="token operator">=</span> <span class="token number">314572800</span> <span class="token punctuation">(</span><span class="token number">300</span>.0MB<span class="token punctuation">)</span>
   NewSize          <span class="token operator">=</span> <span class="token number">209715200</span> <span class="token punctuation">(</span><span class="token number">200</span>.0MB<span class="token punctuation">)</span>
   MaxNewSize       <span class="token operator">=</span> <span class="token number">209715200</span> <span class="token punctuation">(</span><span class="token number">200</span>.0MB<span class="token punctuation">)</span>
   OldSize          <span class="token operator">=</span> <span class="token number">5439488</span> <span class="token punctuation">(</span><span class="token number">5</span>.1875MB<span class="token punctuation">)</span>
   NewRatio         <span class="token operator">=</span> <span class="token number">2</span>
   SurvivorRatio    <span class="token operator">=</span> <span class="token number">8</span>
   PermSize         <span class="token operator">=</span> <span class="token number">104857600</span> <span class="token punctuation">(</span><span class="token number">100</span>.0MB<span class="token punctuation">)</span>
   MaxPermSize      <span class="token operator">=</span> <span class="token number">104857600</span> <span class="token punctuation">(</span><span class="token number">100</span>.0MB<span class="token punctuation">)</span>
   G1HeapRegionSize <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">(</span><span class="token number">0</span>.0MB<span class="token punctuation">)</span>

Heap Usage:
PS Young Generation
Eden Space:
   capacity <span class="token operator">=</span> <span class="token number">167772160</span> <span class="token punctuation">(</span><span class="token number">160</span>.0MB<span class="token punctuation">)</span>
   used     <span class="token operator">=</span> <span class="token number">165346688</span> <span class="token punctuation">(</span><span class="token number">157</span>.6868896484375MB<span class="token punctuation">)</span>
   <span class="token function">free</span>     <span class="token operator">=</span> <span class="token number">2425472</span> <span class="token punctuation">(</span><span class="token number">2</span>.3131103515625MB<span class="token punctuation">)</span>
   <span class="token number">98.55430603027344</span>% used
From Space:
   capacity <span class="token operator">=</span> <span class="token number">20971520</span> <span class="token punctuation">(</span><span class="token number">20</span>.0MB<span class="token punctuation">)</span>
   used     <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">(</span><span class="token number">0</span>.0MB<span class="token punctuation">)</span>
   <span class="token function">free</span>     <span class="token operator">=</span> <span class="token number">20971520</span> <span class="token punctuation">(</span><span class="token number">20</span>.0MB<span class="token punctuation">)</span>
   <span class="token number">0.0</span>% used
To Space:
   capacity <span class="token operator">=</span> <span class="token number">20971520</span> <span class="token punctuation">(</span><span class="token number">20</span>.0MB<span class="token punctuation">)</span>
   used     <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">(</span><span class="token number">0</span>.0MB<span class="token punctuation">)</span>
   <span class="token function">free</span>     <span class="token operator">=</span> <span class="token number">20971520</span> <span class="token punctuation">(</span><span class="token number">20</span>.0MB<span class="token punctuation">)</span>
   <span class="token number">0.0</span>% used
PS Old Generation
   capacity <span class="token operator">=</span> <span class="token number">104857600</span> <span class="token punctuation">(</span><span class="token number">100</span>.0MB<span class="token punctuation">)</span>
   used     <span class="token operator">=</span> <span class="token number">64028920</span> <span class="token punctuation">(</span><span class="token number">61</span>.06273651123047MB<span class="token punctuation">)</span>
   <span class="token function">free</span>     <span class="token operator">=</span> <span class="token number">40828680</span> <span class="token punctuation">(</span><span class="token number">38</span>.93726348876953MB<span class="token punctuation">)</span>
   <span class="token number">61.06273651123047</span>% used
PS Perm Generation
   capacity <span class="token operator">=</span> <span class="token number">104857600</span> <span class="token punctuation">(</span><span class="token number">100</span>.0MB<span class="token punctuation">)</span>
   used     <span class="token operator">=</span> <span class="token number">6504792</span> <span class="token punctuation">(</span><span class="token number">6</span>.203453063964844MB<span class="token punctuation">)</span>
   <span class="token function">free</span>     <span class="token operator">=</span> <span class="token number">98352808</span> <span class="token punctuation">(</span><span class="token number">93</span>.79654693603516MB<span class="token punctuation">)</span>
   <span class="token number">6.203453063964844</span>% used

<span class="token number">3795</span> interned Strings occupying <span class="token number">301744</span> bytes.  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>也就是说如果想知道当前jvm使用的堆内内存，只需要简单的把Heap Usage模块的相关信息累加即可，都可以不关心各个区域的配置信息。</p><p>当然也可以通过jstat -gc pid 500ms 1000来实时查看堆中各个区域的使用情况。这个方式和上面那中方法结果是一致的。</p><ol start="5"><li>查看jvm实例堆外内存的使用情况 很可惜我还没找到相关的工具可以直接查看这个信息的，但可以通过上面几个信息来得到堆外内存的使用情况。大致算法就是：堆内内存占用+堆外内存占用=总的jvm内存占用。 总的jvm内存占用：通过上面的1或2可以知道 堆内内存占用：jmap -heap pid 就可以计算出堆外内存占用情况。</li></ol><p>2022/9/7补充： 应该可以开启 -XX:NativeMemoryTracking=detail 参数，然后通过 jcmd pid VM.native_memory detail | less 来查看</p>`,6),k={start:"6"},m={href:"http://blog.csdn.net/wilsonpeng3/article/details/52576253",target:"_blank",rel:"noopener noreferrer"},v=o(`<div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>btrace<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token import static"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>btrace<span class="token punctuation">.</span></span><span class="token class-name">BTraceUtils</span><span class="token punctuation">.</span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Field</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@BTrace</span> <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloBtrace</span> <span class="token punctuation">{</span>

  <span class="token annotation punctuation">@OnMethod</span><span class="token punctuation">(</span>
    clazz<span class="token operator">=</span><span class="token string">&quot;java.nio.ByteBuffer&quot;</span><span class="token punctuation">,</span>
    method<span class="token operator">=</span><span class="token string">&quot;allocateDirect&quot;</span>
  <span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">onF1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">jstack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Hello BTrace&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>                  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><br><h2 id="系统推荐" tabindex="-1"><a class="header-anchor" href="#系统推荐" aria-hidden="true">#</a> 系统推荐</h2>`,3),b=n("p",null,[n("br"),n("br"),n("br"),n("br"),n("br"),n("br")],-1),E=n("hr",null,null,-1),B=n("hr",null,null,-1),h=n("ul",null,[n("li",null,[n("strong",null,"随机毒鸡汤"),s("：人生有三累——想太多，说不出，没人懂。 "),n("br"),n("br"),n("img",{src:"https://images.pexels.com/photos/31427558/pexels-photo-31427558.jpeg?auto=compress&cs=tinysrgb&h=650&w=940",alt:"Traditional Chinese pagoda with intricate architecture in Dali, Yunnan, China under a bright sky.",loading:"lazy"})])],-1);function f(A,_){const l=p("ExternalLinkIcon"),e=p("RouterLink");return i(),u("div",null,[d,n("ol",k,[n("li",null,[s("堆外内存使用异常 如果发现堆外内存使用异常，先检查是否开启了-XX:+DisableExplicitGC.(开启这个会影响到jvm对堆外内存的回收，所以在频繁使用了堆外内存的情况下，建议不要开启这个选项)。 如果没有开启，那一般就是程序光申请了却没有显式的释放。这个是否如果不清楚程序哪里使用了堆外内存，可以通过btrace脚本进行跟踪来获取调用堆栈，定位代码。 jdk提供用于堆外内存分配的api最底层的应该是Unsafe#allocateMemory方法，但这个方法是native，btrace对native方法的跟踪好像有点问题。所以可以试试拦截上一层的方法， 比如：java.nio.ByteBuffer#allocateDirect方法，示例如下: 至于如何使用btrace，入门可以参考："),n("a",m,[s("http://blog.csdn.net/wilsonpeng3/article/details/52576253"),a(l)]),s(" 关于btrace的另外一些问题，就不再是本话题的讨论内容了。")])]),v,n("ul",null,[n("li",null,[a(e,{to:"/software/unclassified/Oh%20My%20ZSH.html"},{default:t(()=>[s("Oh My ZSH")]),_:1})]),n("li",null,[a(e,{to:"/software/unclassified/Cordova+Umi%E9%A1%B9%E7%9B%AE%E6%90%AD%E5%BB%BA%E6%AD%A5%E9%AA%A4.html"},{default:t(()=>[s("Cordova+Umi项目搭建步骤")]),_:1})]),n("li",null,[a(e,{to:"/software/unclassified/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F.html"},{default:t(()=>[s("记一次内存泄漏")]),_:1})]),n("li",null,[a(e,{to:"/software/docker/Docker%E8%BF%9B%E8%A1%8C%E8%B5%84%E6%BA%90%E9%9A%94%E7%A6%BB.html"},{default:t(()=>[s("Docker进行资源隔离")]),_:1})]),n("li",null,[a(e,{to:"/other/PostgreSQL%E5%AE%9A%E6%97%B6%E5%A4%87%E4%BB%BD.html"},{default:t(()=>[s("PostgreSQL定时备份")]),_:1})]),n("li",null,[a(e,{to:"/software/unclassified/PasteImageIntoMarkdown%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91.html"},{default:t(()=>[s("PasteImageIntoMarkdown插件开发")]),_:1})]),n("li",null,[a(e,{to:"/software/java-basic/AQS%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB.html"},{default:t(()=>[s("AQS源码解读")]),_:1})]),n("li",null,[a(e,{to:"/software/middleware/mysql/%E5%BC%82%E5%9C%B0%E5%A4%9A%E6%B4%BB.html"},{default:t(()=>[s("异地多活")]),_:1})]),n("li",null,[a(e,{to:"/other/%E6%8E%A8%E8%8D%90%E5%87%A0%E4%B8%AA%E9%80%82%E7%94%A8%E5%B0%8F%E5%B7%A5%E5%85%B7.html"},{default:t(()=>[s("推荐几个适用小工具")]),_:1})]),n("li",null,[a(e,{to:"/software/unclassified/%E5%88%B6%E4%BD%9CKVM%20ES%E9%95%9C%E5%83%8F%E6%96%87%E4%BB%B6.html"},{default:t(()=>[s("制作KVM ES镜像文件")]),_:1})]),n("li",null,[a(e,{to:"/software/java-basic/Java%E9%9D%A2%E8%AF%95%E5%9F%BA%E7%A1%80.html"},{default:t(()=>[s("Java面试基础")]),_:1})]),n("li",null,[a(e,{to:"/other/%E5%85%8D%E8%B4%B9%20API%20%E6%AF%8F%E6%97%A5%E6%8F%90%E4%BE%9B%E6%91%B8%E9%B1%BC%E6%97%A5%E6%8A%A5%EF%BC%8C%E8%87%AA%E5%8A%A8%E8%BF%94%E5%9B%9E%E6%97%A0%E6%B0%B4%E5%8D%B0%E5%9B%BE%E7%89%87%EF%BC%8C%E9%80%82%E7%94%A8%E4%BA%8E%E5%85%AC%E4%BC%97%E5%8F%B7%E5%92%8C%E5%B0%8F%E7%A8%8B%E5%BA%8F.html"},{default:t(()=>[s("免费 API 每日提供摸鱼日报，自动返回无水印图片，适用于公众号和小程序")]),_:1})])]),b,E,B,h])}const M=c(r,[["render",f],["__file","JVM异常处理.html.vue"]]);export{M as default};
