import{_ as i,$ as p,a0 as c,a1 as n,a2 as s,a3 as a,a4 as e,a5 as u,w as o}from"./framework-349591b1.js";const r={},d=u(`<p>使用spring的retry框架用两种方式，一种注解方式，一种代码方式，这里主要介绍代码编程方式。</p><p>初始化RetryTemplate主要有两个参数：</p><ol><li>RetryPolicy 主要定义什么情况要进行重试以及重试次数，比如超时、满足某个表达式。</li><li>BackoffPolicy 主要定义两次重试之间的等待时间。backoff这个单词在计算机系统中有很多地方都有，代表的意思基本相同，基本都是重试直接的等待时间。<strong>它的基本思想是在遇到错误时，不是立即重试，而是等待一段时间后再尝试。这种等待的时间通常是逐渐增加的，这就是所谓的“退避”</strong></li></ol><h2 id="retrypolicy" tabindex="-1"><a class="header-anchor" href="#retrypolicy" aria-hidden="true">#</a> RetryPolicy</h2><figure><img src="https://cdn.justdopay.top/notion/md5-19c6d975b35469503fc76e09db892242.png" alt="Untitled" tabindex="0" loading="lazy"><figcaption>Untitled</figcaption></figure><ul><li>SimpleRetryPolicy 默认最多重试3次</li><li>TimeoutRetryPolicy 默认在1秒内失败都会重试</li><li>ExpressionRetryPolicy 符合表达式就会重试</li><li>CircuitBreakerRetryPolicy 增加了熔断的机制，如果不在熔断状态，则允许重试</li><li>CompositeRetryPolicy 可以组合多个重试策略</li><li>NeverRetryPolicy 不重试</li><li>AlwaysRetryPolicy 一直重试</li></ul><h2 id="backoffpolicy" tabindex="-1"><a class="header-anchor" href="#backoffpolicy" aria-hidden="true">#</a> BackoffPolicy</h2><figure><img src="https://cdn.justdopay.top/notion/md5-614e14d24ffe43bce55b4322d1fb8d01.png" alt="Untitled" tabindex="0" loading="lazy"><figcaption>Untitled</figcaption></figure><ul><li>FixedBackOffPolicy 默认固定延迟1秒后执行下一次重试</li><li>ExponentialBackOffPolicy 指数递增延迟执行重试，默认初始0.1秒，系数是2，那么下次延迟0.2秒，再下次就是延迟0.4秒，如此类推，最大30秒。</li><li>ExponentialRandomBackOffPolicy 在上面那个策略上增加随机性</li><li>UniformRandomBackOffPolicy 这个跟上面的区别就是，上面的延迟会不停递增，这个只会在固定的区间随机</li><li>StatelessBackOffPolicy 这个说明是无状态的，所谓无状态就是对上次的退避无感知，从它下面的子类也能看出来</li></ul><p>个人比较喜欢实用 ExponentialBackOffPolicy</p><h2 id="示例" tabindex="-1"><a class="header-anchor" href="#示例" aria-hidden="true">#</a> 示例</h2><figure><img src="https://cdn.justdopay.top/notion/md5-9311b7ee9c5e11088a191a3662ca7f51.png" alt="Untitled" tabindex="0" loading="lazy"><figcaption>Untitled</figcaption></figure><div class="language-jsx line-numbers-mode" data-ext="jsx"><pre class="language-jsx"><code><span class="token keyword">private</span> <span class="token keyword">static</span> final RetryTemplate <span class="token constant">RETRY_TEMPLATE</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token punctuation">{</span>
    <span class="token comment">//重试时间间隔，分别是300ms,600ms,1200ms,依次翻倍，一直到最大时间间隔为3000ms</span>
    ExponentialBackOffPolicy backOffPolicy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExponentialBackOffPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    backOffPolicy<span class="token punctuation">.</span><span class="token function">setInitialInterval</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    backOffPolicy<span class="token punctuation">.</span><span class="token function">setMaxInterval</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token constant">RETRY_TEMPLATE</span> <span class="token operator">=</span> RetryTemplate<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">//当抛这些异常的时候进行重试</span>
            <span class="token punctuation">.</span><span class="token function">retryOn</span><span class="token punctuation">(</span>Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>RemoteAccessException<span class="token punctuation">.</span>class<span class="token punctuation">,</span> TimeoutException<span class="token punctuation">.</span>class<span class="token punctuation">,</span> NullPointerException<span class="token punctuation">.</span>class<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">//最大重试次数为4</span>
            <span class="token punctuation">.</span><span class="token function">maxAttempts</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
            <span class="token comment">//自定义重试时间间隔</span>
            <span class="token punctuation">.</span><span class="token function">customBackoff</span><span class="token punctuation">(</span>backOffPolicy<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> Object <span class="token function">httpRemoteCall</span><span class="token punctuation">(</span><span class="token parameter">Object<span class="token operator">...</span> params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    AtomicInteger retryCounter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">RETRY_TEMPLATE</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>ctx <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;第&quot;</span> <span class="token operator">+</span> retryCounter<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;次执行远程调用&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//在这里正常写远程调用的代码</span>

        <span class="token comment">//正常返回远程调用的结果</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="扩展" tabindex="-1"><a class="header-anchor" href="#扩展" aria-hidden="true">#</a> 扩展</h2>`,14),k={href:"https://github.com/spring-projects/spring-retry",target:"_blank",rel:"noopener noreferrer"},m=n("br",null,null,-1),E=n("h2",{id:"系统推荐",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#系统推荐","aria-hidden":"true"},"#"),s(" 系统推荐")],-1),f=n("p",null,[n("br"),n("br"),n("br"),n("br"),n("br"),n("br")],-1),b=n("hr",null,null,-1),h=n("hr",null,null,-1),y=n("ul",null,[n("li",null,[n("strong",null,"随机毒鸡汤"),s("：只要我把自己吃得够圆，就没人能把我看扁。 "),n("br"),n("br"),n("img",{src:"https://images.pexels.com/photos/32113433/pexels-photo-32113433.jpeg?auto=compress&cs=tinysrgb&h=650&w=940",alt:"A groom in a beige suit smiles at his bride during an outdoor wedding ceremony.",loading:"lazy"})])],-1);function v(g,A){const l=o("ExternalLinkIcon"),t=o("RouterLink");return p(),c("div",null,[d,n("p",null,[n("a",k,[s("https://github.com/spring-projects/spring-retry"),a(l)])]),m,E,n("ul",null,[n("li",null,[a(t,{to:"/software/middleware/mysql/MySQL%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4.html"},{default:e(()=>[s("MySQL常用命令")]),_:1})]),n("li",null,[a(t,{to:"/software/jvm/JVM%E5%8F%82%E6%95%B0%E8%AE%BE%E7%BD%AE.html"},{default:e(()=>[s("JVM参数设置")]),_:1})]),n("li",null,[a(t,{to:"/other/Nacos-Spring%20Gateway-Spring%20boot%E6%97%A0%E6%84%9F%E5%8F%91%E5%B8%83.html"},{default:e(()=>[s("Nacos-Spring Gateway-Spring boot无感发布")]),_:1})]),n("li",null,[a(t,{to:"/other/PGSQL%20GIN%E7%B4%A2%E5%BC%95%E2%80%9C%E5%A4%B1%E6%95%88%E2%80%9D.html"},{default:e(()=>[s("PGSQL GIN索引“失效”")]),_:1})]),n("li",null,[a(t,{to:"/software/java-basic/IO%E7%9B%B8%E5%85%B3.html"},{default:e(()=>[s("IO相关")]),_:1})]),n("li",null,[a(t,{to:"/software/unclassified/%E7%AE%80%E6%98%93%E7%89%88%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83&%E5%88%9D%E6%8E%A2%E5%8E%9F%E7%90%86.html"},{default:e(()=>[s("简易版配置中心&初探原理")]),_:1})]),n("li",null,[a(t,{to:"/software/unclassified/Flutter%E5%BC%80%E5%8F%91%E9%9C%80%E8%A6%81%E6%B6%89%E5%8F%8A%E7%9A%84%E7%9F%A5%E8%AF%86%E7%82%B9%E5%A4%A7%E7%BA%B2.html"},{default:e(()=>[s("Flutter开发需要涉及的知识点大纲")]),_:1})]),n("li",null,[a(t,{to:"/other/Arthas%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95.html"},{default:e(()=>[s("Arthas使用记录")]),_:1})]),n("li",null,[a(t,{to:"/other/MyBatis%20xml%E7%89%B9%E6%AE%8A%E5%AD%97%E7%AC%A6%E5%A4%84%E7%90%86.html"},{default:e(()=>[s("MyBatis xml特殊字符处理")]),_:1})]),n("li",null,[a(t,{to:"/software/java-basic/ReentrantLock%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB.html"},{default:e(()=>[s("ReentrantLock源码解读")]),_:1})]),n("li",null,[a(t,{to:"/other/SpringBoot%E6%9C%8D%E5%8A%A1%E5%9C%A8%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8%E5%AE%8C%E6%88%90%E5%89%8D%E8%A2%AB%E6%8F%90%E5%89%8D%E6%B3%A8%E5%86%8C%E5%88%B0nacos.html"},{default:e(()=>[s("SpringBoot服务在服务启动完成前被提前注册到nacos")]),_:1})]),n("li",null,[a(t,{to:"/other/Hbase%20%E6%80%BB%E8%A7%88.html"},{default:e(()=>[s("Hbase 总览")]),_:1})])]),f,b,h,y])}const _=i(r,[["render",v],["__file","Spring RetryTemplate.html.vue"]]);export{_ as default};
