import{_ as r,$ as i,a0 as c,a1 as a,a2 as n,a3 as s,a4 as o,a5 as l,w as p}from"./framework-8c4427da.js";const d={},u=l(`<h2 id="背景" tabindex="-1"><a class="header-anchor" href="#背景" aria-hidden="true">#</a> 背景</h2><p>k8s环境中有个pod，pod里跑了一个java进程。 采用的是jdk版本是openjdk version &quot;1.8.0_342&quot;。 启动时有这些jvm参数：</p><div class="language-jsx line-numbers-mode" data-ext="jsx"><pre class="language-jsx"><code><span class="token operator">-</span>server 
<span class="token operator">-</span>Dspring<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span>druid<span class="token punctuation">.</span>maxActive<span class="token operator">=</span><span class="token number">80</span> 
<span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span>MaxGCPauseMillis<span class="token operator">=</span><span class="token number">200</span> 
<span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token operator">+</span>UseG1GC 
<span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token operator">+</span>UseContainerSupport 
<span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span>MinRAMPercentage<span class="token operator">=</span><span class="token number">20.0</span> 
<span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span>MaxRAMPercentage<span class="token operator">=</span><span class="token number">70.0</span> 
<span class="token operator">-</span>Djava<span class="token punctuation">.</span>security<span class="token punctuation">.</span>egd<span class="token operator">=</span>file<span class="token operator">:</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">dev</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token operator">/</span>urandom 
<span class="token operator">-</span>Duser<span class="token punctuation">.</span>timezone<span class="token operator">=</span><span class="token constant">GMT</span><span class="token operator">+</span><span class="token number">08</span> 
<span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token operator">+</span>HeapDumpOnOutOfMemoryError  
<span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span>HeapDumpPath<span class="token operator">=</span><span class="token operator">/</span>mnt<span class="token operator">/</span>log 
<span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token operator">+</span>UnlockExperimentalVMOptions
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>depoyment的yaml文件中限制的内存是4g.</p><p>现在发现这个deployment的5个pod内存都占用了90%以上，且<strong>持续不降</strong>，部分pod还重启过3/4次</p><figure><img src="https://cdn.justdopay.top/notion/md5-2d9f65e42e4bb20d061c30e5f8a32e49.png" alt="image.png" tabindex="0" loading="lazy"><figcaption>image.png</figcaption></figure><h2 id="排查过程" tabindex="-1"><a class="header-anchor" href="#排查过程" aria-hidden="true">#</a> 排查过程</h2><h3 id="怀疑存在内存泄漏或内存溢出" tabindex="-1"><a class="header-anchor" href="#怀疑存在内存泄漏或内存溢出" aria-hidden="true">#</a> 怀疑存在内存泄漏或内存溢出</h3><p>于是进入pod把堆dump下来，下载到本地分析。（由于是客户环境，没有权限直接操作k8s，只能访问dashborad面板，所以下载文件这个过程也是挺折腾的）</p><p>dump下来的堆文件确只有不到2g样子（有点纳闷，但没深究）</p>`,10),m={href:"https://justsoso.fun/software/unclassified/%E7%BA%BF%E4%B8%8AFullGC%E9%A2%91%E7%B9%81%E7%9A%84%E6%8E%92%E6%9F%A5.html",target:"_blank",rel:"noopener noreferrer"},g=l(`<h3 id="查看gc情况" tabindex="-1"><a class="header-anchor" href="#查看gc情况" aria-hidden="true">#</a> 查看gc情况</h3><figure><img src="https://cdn.justdopay.top/notion/md5-8935ab54643f82cb0505547077e94dad.png" alt="image.png" tabindex="0" loading="lazy"><figcaption>image.png</figcaption></figure><p>可以看到，青年代发生了1.3万次gc，老年代没有发生过gc. (此时离pod启用有9天时间)</p><p>同时也能看到内存分配和使用情况：</p><ol><li>堆内存： 使用了1.6g， committed2.8g内存（可以理解为jvm向操作系统申请了2.8g内存），最大堆内存限制为2.8g. （这个2.8就是deployment的4<em>MaxRAMPercentage参数，也就是4</em>0.7=2.8）</li><li>非堆内存：包括直接内存、metaspace 、code cache 等。 使用了400m不到，committed400m内存。</li></ol><p>然后很好奇的手动执行了一次fullgc，再看jvm情况，如下：</p><figure><img src="https://cdn.justdopay.top/notion/md5-26dd62714972e64dba8cf0387c95262f.png" alt="image.png" tabindex="0" loading="lazy"><figcaption>image.png</figcaption></figure><p>然后看k8s的dashboard</p><figure><img src="https://cdn.justdopay.top/notion/md5-fa647b017084e3877222a3398a1abb85.png" alt="image.png" tabindex="0" loading="lazy"><figcaption>image.png</figcaption></figure><p><strong>注意：因为这篇博文是事后写的，上面的图有些并不是同一个pod的信息，所以有些信息会对不上，但不影响问题分析。</strong></p><p>可以看到堆内存的used和committed下降了，committed下降了大概1.3g样子，刚好就是dashboard上显示的内存差异，非堆内存几乎没有下降。</p><p>执行了fullgc后第二天，bashboard内存占用基本没有变动，没有再升上去</p><p>可以分析得出一个基本结论：</p><ol><li><strong>问题在堆内存，且代码可以基本排除内存泄漏或溢出的问题</strong></li><li><strong>青年代的gc 没有退还内存给操作系统，fullgc后退还了1.3g样子给操作系统</strong></li></ol><p>查资料，尝试增加jvm参数：</p><div class="language-jsx line-numbers-mode" data-ext="jsx"><pre class="language-jsx"><code><span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span>MaxHeapFreeRatio<span class="token operator">=</span><span class="token number">30</span>
<span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span>MinHeapFreeRatio<span class="token operator">=</span><span class="token number">10</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><code>-XX:MaxHeapFreeRatio=30</code> 最大堆内存空闲比例，大致理解为jvm向操作系统了申请了2g内存，gc后只使用了1g. 那么空闲了1g，空闲比例就是50%，大于了30%，于是就会退还内存给操作系统。</p><p><code>-XX:MinHeapFreeRatio=10</code> 同理，最小堆内存空闲比例，如果gc空闲比例小于了这个值，jvm就会向操作系统申请更多的内存</p><p>后面也尝试增加过其他参数</p><p>观察一段时间后，发现青年代gc后，还是没有减少committed内存。也没有增加老年代的gc次数</p><h2 id="解决" tabindex="-1"><a class="header-anchor" href="#解决" aria-hidden="true">#</a> 解决</h2><p>其实算不上解决，或者解决得不够优雅。考虑到切换jdk版本，或者修改垃圾收集器可能产生意料之外的问题和成本，所以采用：</p><ul><li>周期性触发一次fullgc. 比如通过sidecar，或者linux的crontab或者代码定时任务等。</li></ul><h2 id="后文" tabindex="-1"><a class="header-anchor" href="#后文" aria-hidden="true">#</a> 后文</h2><p>后面再继续查资料，搜到一个类似问题的网址：</p>`,25),h={href:"https://stackoverflow.com/questions/29826465/how-to-reduce-committed-heap-memory-in-jvm",target:"_blank",rel:"noopener noreferrer"},k=a("figure",null,[a("img",{src:"https://cdn.justdopay.top/notion/md5-b021f2838282cc9e3fd9cc6132b09768.png",alt:"image.png",tabindex:"0",loading:"lazy"}),a("figcaption",null,"image.png")],-1),E=a("br",null,null,-1),f=a("h2",{id:"系统推荐",tabindex:"-1"},[a("a",{class:"header-anchor",href:"#系统推荐","aria-hidden":"true"},"#"),n(" 系统推荐")],-1),b=a("p",null,[a("br"),a("br"),a("br"),a("br"),a("br"),a("br")],-1),_=a("hr",null,null,-1),v=a("hr",null,null,-1),B=a("ul",null,[a("li",null,[a("strong",null,"随机毒鸡汤"),n("：目前最靠谱的发财方法，就是，你家拆迁了。 "),a("br"),a("br"),a("img",{src:"https://images.pexels.com/photos/10390896/pexels-photo-10390896.jpeg?auto=compress&cs=tinysrgb&h=650&w=940",alt:"Close-up of a rustic wooden wall featuring white numeric markings on a reddish-brown background.",loading:"lazy"})])],-1);function A(x,j){const t=p("ExternalLinkIcon"),e=p("RouterLink");return i(),c("div",null,[u,a("p",null,[n("采用与博文 "),a("a",m,[n("线上FullGC频繁的排查"),s(t)]),n(" 排查方式分析堆文件，一无所获。")]),g,a("p",null,[a("a",h,[n("how-to-reduce-committed-heap-memory-in-jvm"),s(t)])]),k,E,f,a("ul",null,[a("li",null,[s(e,{to:"/software/unclassified/Git%E7%AC%94%E8%AE%B0.html"},{default:o(()=>[n("Git笔记")]),_:1})]),a("li",null,[s(e,{to:"/software/jvm/JVM%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8.html"},{default:o(()=>[n("JVM垃圾收集器")]),_:1})]),a("li",null,[s(e,{to:"/software/spring/%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98.html"},{default:o(()=>[n("常见问题")]),_:1})]),a("li",null,[s(e,{to:"/software/middleware/mysql/MySQL%E6%9D%82%E9%A1%B9.html"},{default:o(()=>[n("MySQL杂项")]),_:1})]),a("li",null,[s(e,{to:"/software/middleware/es/ES6.2.3(3%E8%8A%82%E7%82%B9)%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB%E5%88%B0ES7.4.1(5%E8%8A%82%E7%82%B9).html"},{default:o(()=>[n("ES6.2.3(3节点)数据迁移到ES7.4.1(5节点)")]),_:1})]),a("li",null,[s(e,{to:"/other/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E5%88%B6%E4%BD%9CCookie%E3%80%81Local%E3%80%81Session%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%87%BA%E6%8F%92%E4%BB%B6.html"},{default:o(()=>[n("手把手教你制作Cookie、Local、Session数据导出插件")]),_:1})]),a("li",null,[s(e,{to:"/other/%E6%98%AF%E6%97%B6%E5%80%99%E4%BD%BF%E7%94%A8MapStruct%E6%9B%BF%E4%BB%A3BeanUtils%E4%BA%86.html"},{default:o(()=>[n("是时候使用MapStruct替代BeanUtils了")]),_:1})]),a("li",null,[s(e,{to:"/other/PGSQL%E7%9A%84json%E5%92%8C%20jsonb%20%E8%AF%BB%E5%86%99%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95.html"},{default:o(()=>[n("PGSQL的json和 jsonb 读写性能测试")]),_:1})]),a("li",null,[s(e,{to:"/software/shodowsocks/ShadowsockServer%E9%85%8D%E7%BD%AE.html"},{default:o(()=>[n("ShadowsockServer配置")]),_:1})]),a("li",null,[s(e,{to:"/software/unclassified/%E5%89%8D%E5%90%8E%E7%AB%AF%E5%B8%B8%E7%94%A8%E6%8A%80%E6%9C%AF.html"},{default:o(()=>[n("前后端常用技术")]),_:1})]),a("li",null,[s(e,{to:"/software/unclassified/BBR%E5%8A%A0%E9%80%9F.html"},{default:o(()=>[n("BBR加速")]),_:1})]),a("li",null,[s(e,{to:"/software/raft/raft%E5%8D%8F%E8%AE%AE.html"},{default:o(()=>[n("raft协议")]),_:1})])]),b,_,v,B])}const X=r(d,[["render",A],["__file","JDK8 G1 堆内存居然不释放.html.vue"]]);export{X as default};
