<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.61" />
    <meta name="theme" content="VuePress Theme Hope" />
    <link rel="canonical" href="https://justsoso.fun/software/middleware/mysql/SQL%E4%BC%98%E5%8C%96.html"><meta property="og:url" content="https://justsoso.fun/software/middleware/mysql/SQL%E4%BC%98%E5%8C%96.html"><meta property="og:site_name" content="技术加油站"><meta property="og:title" content="SQL优化"><meta property="og:description" content="SQL优化从我自己的经验来说的，我自己总结了几个方面吧，主要从以下几个方面来着手： explain profiling sql使用技巧 explain 一般比较关注type,key,rows,extra几列 type: 描述了表之间是如何进行连接的 key: 真正使用的索引 rows: 预估扫描的行数，不是预估返回的行数 extra: 额外的信息 explain输出行的id值越大，越先执行。id如果相同，从上往下顺序执行。"><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2024-02-20T08:10:39.000Z"><meta property="article:published_time" content="2018-09-05T00:00:00.000Z"><meta property="article:modified_time" content="2024-02-20T08:10:39.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"SQL优化","image":[""],"datePublished":"2018-09-05T00:00:00.000Z","dateModified":"2024-02-20T08:10:39.000Z","author":[]}</script><meta name="referrer" content="no-referrer-when-downgrade"><meta name="google-adsense-account" content="ca-pub-6065963683065405"><script async crossOrigin="anonymous" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6065963683065405"></script><script async crossOrigin="anonymous" src="//cdn.justdopay.com/scripts/busuanzi.pure.mini.js"></script><title>SQL优化 | 技术加油站</title><meta name="description" content="SQL优化从我自己的经验来说的，我自己总结了几个方面吧，主要从以下几个方面来着手： explain profiling sql使用技巧 explain 一般比较关注type,key,rows,extra几列 type: 描述了表之间是如何进行连接的 key: 真正使用的索引 rows: 预估扫描的行数，不是预估返回的行数 extra: 额外的信息 explain输出行的id值越大，越先执行。id如果相同，从上往下顺序执行。">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-1193ddd2.css" as="style"><link rel="stylesheet" href="/assets/style-1193ddd2.css">
    <link rel="modulepreload" href="/assets/app-4845962f.js"><link rel="modulepreload" href="/assets/framework-28382e28.js"><link rel="modulepreload" href="/assets/SQL优化.html-cb3e56cf.js"><link rel="modulepreload" href="/assets/SQL优化.html-5d808c80.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container has-toc"><!--[--><header class="navbar" id="navbar"><div class="navbar-start"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/" class="brand"><img class="logo" src="/logo.svg" alt="技术加油站"><!----><span class="site-name hide-in-pad">技术加油站</span></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/dachang-project-review/" class="nav-link" aria-label="大厂项目复盘"><FontIcon icon="discover"></FontIcon>大厂项目复盘<!----></a></div><div class="nav-item hide-in-mobile"><a href="/software/" class="nav-link active" aria-label="Java技术栈"><FontIcon icon="discover"></FontIcon>Java技术栈<!----></a></div><div class="nav-item hide-in-mobile"><a href="/other/" class="nav-link" aria-label="其他"><FontIcon icon="discover"></FontIcon>其他<!----></a></div></nav><!--[--><!----><!--]--></div><div class="navbar-end"><!--[--><!----><!--]--><!----><div class="nav-item"><a class="repo-link" href="https://github.com/rocky-peng/rocky-peng.github.io" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!--[--><button class="search-pro-button" role="search" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="placeholder">搜索</div><div class="key-hints"><kbd class="key">Ctrl</kbd><kbd class="key">K</kbd></div></button><!--]--><!--[--><!----><!--]--><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside class="sidebar" id="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable"><FontIcon></FontIcon><span class="title">Docker</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><FontIcon></FontIcon><span class="title">JAVA基础</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><FontIcon></FontIcon><span class="title">JVM相关</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><FontIcon></FontIcon><span class="title">Linux</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><FontIcon></FontIcon><span class="title">Maccms</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><FontIcon></FontIcon><span class="title">Raft</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><FontIcon></FontIcon><span class="title">Shodowsocks</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><FontIcon></FontIcon><span class="title">Spring</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active"><FontIcon></FontIcon><span class="title">中间件</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable"><FontIcon></FontIcon><span class="title">ElasticSearch</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><FontIcon></FontIcon><span class="title">MQ</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active"><FontIcon></FontIcon><span class="title">MySQL</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a href="/software/middleware/mysql/InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E.html" class="nav-link sidebar-link sidebar-page" aria-label="InnoDB存储引擎"><FontIcon></FontIcon>InnoDB存储引擎<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/software/middleware/mysql/MySQL%E4%B8%89%E5%A4%A7%E6%97%A5%E5%BF%97.html" class="nav-link sidebar-link sidebar-page" aria-label="MySQL三大日志"><FontIcon></FontIcon>MySQL三大日志<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/software/middleware/mysql/MySQL%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4.html" class="nav-link sidebar-link sidebar-page" aria-label="MySQL常用命令"><FontIcon></FontIcon>MySQL常用命令<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/software/middleware/mysql/MySQL%E6%9D%82%E9%A1%B9.html" class="nav-link sidebar-link sidebar-page" aria-label="MySQL杂项"><FontIcon></FontIcon>MySQL杂项<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/software/middleware/mysql/MySQL%E7%B4%A2%E5%BC%95.html" class="nav-link sidebar-link sidebar-page" aria-label="MySQL索引"><FontIcon></FontIcon>MySQL索引<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/software/middleware/mysql/MySQL%E9%94%81%E3%80%81%E4%BA%8B%E5%8A%A1%E3%80%81%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB.html" class="nav-link sidebar-link sidebar-page" aria-label="MySQL锁、事务、隔离级别"><FontIcon></FontIcon>MySQL锁、事务、隔离级别<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/software/middleware/mysql/SQL%E4%BC%98%E5%8C%96.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="SQL优化"><FontIcon></FontIcon>SQL优化<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/software/middleware/mysql/SQL%E4%BC%98%E5%8C%96.html#explain" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="explain"><FontIcon></FontIcon>explain<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/software/middleware/mysql/SQL%E4%BC%98%E5%8C%96.html#extra列实战" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="extra列实战"><FontIcon></FontIcon>extra列实战<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/software/middleware/mysql/SQL%E4%BC%98%E5%8C%96.html#type列实战" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="type列实战"><FontIcon></FontIcon>type列实战<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/software/middleware/mysql/SQL%E4%BC%98%E5%8C%96.html#profiling" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="profiling"><FontIcon></FontIcon>profiling<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/software/middleware/mysql/SQL%E4%BC%98%E5%8C%96.html#sql使用技巧" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="SQL使用技巧"><FontIcon></FontIcon>SQL使用技巧<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/software/middleware/mysql/SQL%E4%BC%98%E5%8C%96.html#icp-index-condition-pushdown" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="ICP(Index Condition PushDown)"><FontIcon></FontIcon>ICP(Index Condition PushDown)<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/software/middleware/mysql/SQL%E4%BC%98%E5%8C%96.html#mysql执行计划" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="MySQL执行计划"><FontIcon></FontIcon>MySQL执行计划<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/software/middleware/mysql/SQL%E4%BC%98%E5%8C%96.html#小表驱动大表" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="小表驱动大表"><FontIcon></FontIcon>小表驱动大表<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/software/middleware/mysql/SQL%E4%BC%98%E5%8C%96.html#何为小表驱动大表" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="何为小表驱动大表"><FontIcon></FontIcon>何为小表驱动大表<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/software/middleware/mysql/SQL%E4%BC%98%E5%8C%96.html#如何区分驱动表与被驱动表" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="如何区分驱动表与被驱动表"><FontIcon></FontIcon>如何区分驱动表与被驱动表<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/software/middleware/mysql/SQL%E4%BC%98%E5%8C%96.html#join的时候谁是驱动表" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="join的时候谁是驱动表"><FontIcon></FontIcon>join的时候谁是驱动表<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/software/middleware/mysql/SQL%E4%BC%98%E5%8C%96.html#exsit与in" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Exsit与In"><FontIcon></FontIcon>Exsit与In<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/software/middleware/mysql/SQL%E4%BC%98%E5%8C%96.html#哪些情况会出现全表扫描" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="哪些情况会出现全表扫描"><FontIcon></FontIcon>哪些情况会出现全表扫描<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/software/middleware/mysql/SQL%E4%BC%98%E5%8C%96.html#in-和-exist语句" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="IN 和 EXIST语句"><FontIcon></FontIcon>IN 和 EXIST语句<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/software/middleware/mysql/SQL%E4%BC%98%E5%8C%96.html#use-index-与-force-index的区别" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="use index 与 force index的区别？"><FontIcon></FontIcon>use index 与 force index的区别？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/software/middleware/mysql/SQL%E4%BC%98%E5%8C%96.html#show-index-from-库名-表名" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="show index from 库名.表名"><FontIcon></FontIcon>show index from 库名.表名<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/software/middleware/mysql/SQL%E4%BC%98%E5%8C%96.html#实际例子" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="实际例子"><FontIcon></FontIcon>实际例子<!----></a><ul class="sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a href="/software/middleware/mysql/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1Seata.html" class="nav-link sidebar-link sidebar-page" aria-label="分布式事务Seata"><FontIcon></FontIcon>分布式事务Seata<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/software/middleware/mysql/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8.html" class="nav-link sidebar-link sidebar-page" aria-label="分库分表"><FontIcon></FontIcon>分库分表<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/software/middleware/mysql/%E5%BC%82%E5%9C%B0%E5%A4%9A%E6%B4%BB.html" class="nav-link sidebar-link sidebar-page" aria-label="异地多活"><FontIcon></FontIcon>异地多活<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><FontIcon></FontIcon><span class="title">Redis</span><span class="arrow end"></span></button><!----></section></li></ul></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><FontIcon></FontIcon><span class="title">八股文</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><FontIcon></FontIcon><span class="title">操作系统</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><FontIcon></FontIcon><span class="title">未分类的</span><span class="arrow end"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><FontIcon></FontIcon>SQL优化</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://justsoso.fun" target="_blank" rel="noopener noreferrer">技术加油站</a></span><span property="author" content="技术加油站"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2018-09-05T00:00:00.000Z"></span><!----><!----><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 20 分钟</span><meta property="timeRequired" content="PT20M"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">此页内容<button class="print-button" title="print"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/software/middleware/mysql/SQL%E4%BC%98%E5%8C%96.html#explain" class="router-link-active router-link-exact-active toc-link level2">explain</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/software/middleware/mysql/SQL%E4%BC%98%E5%8C%96.html#extra列实战" class="router-link-active router-link-exact-active toc-link level3">extra列实战</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/software/middleware/mysql/SQL%E4%BC%98%E5%8C%96.html#type列实战" class="router-link-active router-link-exact-active toc-link level3">type列实战</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/software/middleware/mysql/SQL%E4%BC%98%E5%8C%96.html#profiling" class="router-link-active router-link-exact-active toc-link level2">profiling</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/software/middleware/mysql/SQL%E4%BC%98%E5%8C%96.html#sql使用技巧" class="router-link-active router-link-exact-active toc-link level2">SQL使用技巧</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/software/middleware/mysql/SQL%E4%BC%98%E5%8C%96.html#icp-index-condition-pushdown" class="router-link-active router-link-exact-active toc-link level2">ICP(Index Condition PushDown)</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/software/middleware/mysql/SQL%E4%BC%98%E5%8C%96.html#mysql执行计划" class="router-link-active router-link-exact-active toc-link level2">MySQL执行计划</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/software/middleware/mysql/SQL%E4%BC%98%E5%8C%96.html#小表驱动大表" class="router-link-active router-link-exact-active toc-link level2">小表驱动大表</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/software/middleware/mysql/SQL%E4%BC%98%E5%8C%96.html#何为小表驱动大表" class="router-link-active router-link-exact-active toc-link level3">何为小表驱动大表</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/software/middleware/mysql/SQL%E4%BC%98%E5%8C%96.html#如何区分驱动表与被驱动表" class="router-link-active router-link-exact-active toc-link level3">如何区分驱动表与被驱动表</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/software/middleware/mysql/SQL%E4%BC%98%E5%8C%96.html#join的时候谁是驱动表" class="router-link-active router-link-exact-active toc-link level3">join的时候谁是驱动表</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/software/middleware/mysql/SQL%E4%BC%98%E5%8C%96.html#exsit与in" class="router-link-active router-link-exact-active toc-link level3">Exsit与In</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/software/middleware/mysql/SQL%E4%BC%98%E5%8C%96.html#哪些情况会出现全表扫描" class="router-link-active router-link-exact-active toc-link level2">哪些情况会出现全表扫描</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/software/middleware/mysql/SQL%E4%BC%98%E5%8C%96.html#in-和-exist语句" class="router-link-active router-link-exact-active toc-link level3">IN 和 EXIST语句</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/software/middleware/mysql/SQL%E4%BC%98%E5%8C%96.html#use-index-与-force-index的区别" class="router-link-active router-link-exact-active toc-link level2">use index 与 force index的区别？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/software/middleware/mysql/SQL%E4%BC%98%E5%8C%96.html#show-index-from-库名-表名" class="router-link-active router-link-exact-active toc-link level2">show index from 库名.表名</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/software/middleware/mysql/SQL%E4%BC%98%E5%8C%96.html#实际例子" class="router-link-active router-link-exact-active toc-link level2">实际例子</a></li><!----><!--]--></ul></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><p>SQL优化从我自己的经验来说的，我自己总结了几个方面吧，主要从以下几个方面来着手：</p><ol><li>explain</li><li>profiling</li><li>sql使用技巧</li></ol><h2 id="explain" tabindex="-1"><a class="header-anchor" href="#explain" aria-hidden="true">#</a> explain</h2><p>一般比较关注type,key,rows,extra几列</p><ol><li><p>type: 描述了表之间是如何进行连接的</p></li><li><p>key: 真正使用的索引</p></li><li><p>rows: 预估扫描的行数，不是预估返回的行数</p></li><li><p>extra: 额外的信息</p></li><li><p>explain输出行的id值越大，越先执行。id如果相同，从上往下顺序执行。</p></li></ol><p>扩展阅读： <a href="https://blog.csdn.net/horses/article/details/106905110" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/horses/article/details/106905110<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h3 id="extra列实战" tabindex="-1"><a class="header-anchor" href="#extra列实战" aria-hidden="true">#</a> extra列实战</h3><ol><li>using index: 使用了覆盖索引</li><li>using where: 表示mysql服务器将在存储引擎检索行后再进行过滤</li><li>using filesort: order的列没有索引或者没有用到order列的索引 order by 没有用到索引的情况有： <ul><li>order by的列就没有建立相关索引</li><li>order by的列存在相关索引，但和where条件中使用的索引不同</li></ul></li><li>using index condition: 使用的是辅助索引，但进行了回表操作（也就是说还走了一次主键索引）</li><li>null: 使用的是主键索引，但筛选的数据不全在索引中</li></ol><h3 id="type列实战" tabindex="-1"><a class="header-anchor" href="#type列实战" aria-hidden="true">#</a> type列实战</h3><ol><li><p>ALL 全表扫描</p></li><li><p>index 索引全扫描</p></li><li><p>range 索引范围扫描，常用语&lt;,&lt;=,&gt;=,between等操作</p></li><li><p>ref 使用了非唯一索引或唯一索引的左侧部分，返回可能多余一条的数据</p></li><li><p>eq_ref 类似ref，使用到了聚集索引或唯一非空索引的全部组成部分，使用了 = 或者 join 来关联其他表的某列</p><div class="language-mysql line-numbers-mode" data-ext="mysql"><pre class="language-mysql"><code>SELECT * FROM ref_table,other_table WHERE ref_table.key_column=other_table.column;

SELECT * FROM ref_table,other_table WHERE ref_table.key_column_part1=other_table.column AND ref_table.key_column_part2=1;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>const/system 只有使用到了聚集索引或唯一索引的全部组成部分才会是const，因此结果集最多只会有一行数据</p><div class="language-mysql line-numbers-mode" data-ext="mysql"><pre class="language-mysql"><code>SELECT * FROM tbl_name WHERE primary_key=1;

SELECT * FROM tbl_name WHERE unique_key=1;

SELECT * FROM tbl_name WHERE primary_key_part1=1 AND primary_key_part2=2;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>null MySQL不访问任何表或索引，直接返回结果</p></li></ol><h2 id="profiling" tabindex="-1"><a class="header-anchor" href="#profiling" aria-hidden="true">#</a> profiling</h2><p>这种方式和使用performance_schema数据库是等效的。</p><p>使用performance_schema数据库的具体步骤参考：<a href="https://dev.mysql.com/doc/refman/5.7/en/performance-schema-query-profiling.html" target="_blank" rel="noopener noreferrer">https://dev.mysql.com/doc/refman/5.7/en/performance-schema-query-profiling.html<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h4 id="怎么玩" tabindex="-1"><a class="header-anchor" href="#怎么玩" aria-hidden="true">#</a> 怎么玩</h4><ol><li><p>执行set profiling = 1 开启该功能</p><p>可用通过 show variables like &#39;profiling&#39;查看是否已经开启。</p><p>这个变量的作用范围既可以是整个系统，也可以是当前会话，具体参考：<a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-parameters.html" target="_blank" rel="noopener noreferrer">https://dev.mysql.com/doc/refman/5.7/en/innodb-parameters.html<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></li><li><p>执行sql语句</p></li><li><p>执行set profiling = 0 关闭该功能</p></li><li><p>执行show profiles找到刚才执行的sql语句的query_id. <img src="https://cdn.justdopay.com/xiaoshujiang/1629079678303.png" alt="enter description here" loading="lazy"></p><p>一般只会展示15条记录，可通过参数 profiling_history_size 修改</p></li><li><p>执行show profile all for query query_id 来查看耗时清单 <img src="https://cdn.justdopay.com/xiaoshujiang/1629079685213.png" alt="enter description here" loading="lazy"></p><p>具体显示哪些列：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>ALL：显示所有的开销信息
BLOCK IO：显示块IO相关开销
CONTEXT SWITCHES：上下文切换相关开销
CPU：显示CPU相关开销
IPC：显示发送和接受相关开销
MEMORY：显示内存相关开销
PAGE FAULTS：显示页面错误相关开销
SOURCE：显示和Source_function, Source_file,Source_line相关的相关开销
SWAPS：显示交换次数相关开销
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><h4 id="注意" tabindex="-1"><a class="header-anchor" href="#注意" aria-hidden="true">#</a> 注意</h4><p>如果在其生命周期阶段出现如下的情况的就要重视了：</p><ol><li><p>converting HEAP to MyISAM 表示正在将基于内存的临时表转储到基于磁盘的临时表上</p><p>MySQL会使用Memory存储引擎的表来作为临时表来存放查询产生的中间结果，如果中间结果集大于了memory存储引擎表的容量（tmp_table_size参数控制），或者中间结果包括了memory存储引擎表不支持的数据类型，mysql又将此中间结果转换为MyISAM存储引擎表而存放在磁盘上。而MyISAM表是不缓存数据文件的，因此产生这样的临时表对于查询的性能会有所降低，所以在查询时尽量避免产生临时表。</p></li><li><p>Creating tmp table 创建了临时表，先拷贝到临时表，用完后再删除</p></li><li><p>Copying to tmp table on disk 把内存中的临时表复制到磁盘中，这个很耗性能</p></li><li><p>Locked 这个就是指在等待锁的意思</p></li></ol><div class="language-mysql line-numbers-mode" data-ext="mysql"><pre class="language-mysql"><code>查看全局创建的内存临时表数量
SHOW GLOBAL STATUS LIKE &#39;Created_tmp_tables&#39;;

查看全局创建的磁盘临时表数量
SHOW GLOBAL STATUS LIKE &#39;Created_tmp_disk_tables&#39;;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="sql使用技巧" tabindex="-1"><a class="header-anchor" href="#sql使用技巧" aria-hidden="true">#</a> SQL使用技巧</h2><ol><li>是否有索引</li><li>覆盖索引 <ul><li>可以避免回表操作</li></ul></li><li>避免隐式的类型转换</li><li>连表的两个字段必须保持相同的数据类型和字符集 <ul><li>有可能不能使用索引，造成全表扫描</li></ul></li><li>not exist与not in(优先选择not exist) <ul><li>not in使用不当还有可能返回错误结果。 如果not in子查询包含了null，将返回空数据。 如果not in子查询返回空数据，将匹配所有行数据</li><li>not in (1,null) : 返回空数据</li><li>not in (select 1 where 1=0) : 返回所有数据</li></ul></li><li>索引字段进行表达式或函数计算 <ul><li>会造成全表扫描</li></ul></li><li>不满足左匹配原则，比如模糊查询 <ul><li>会造成全表扫描</li></ul></li><li>!=（不等于） <ul><li>会造成全表扫描</li></ul></li><li>索引字段尽量建立在区分度高的列上 <ul><li>比如在is_del这样的字段上加索引意义就不是很大</li></ul></li><li>长字段单独一张表</li></ol><ul><li>从b+数的结构上解释，一页的空间是16kb，存放的数据占用空间越小那么一页存放的数据越多，整棵树就更加矮胖，IO次数就越少，效率越高</li></ul><ol start="11"><li>in与exist（各有适用场景：<a href="https://mp.weixin.qq.com/s/KpTG1WUlcP6cyk8Y9SMcyQ" target="_blank" rel="noopener noreferrer">in和exist的选择<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li>小表驱动大表</li><li>时间排序转换为id排序</li><li>分页技巧（断点分页）</li><li>表设计时，满足要求的情况下尽量选择占用空间小的数据类型</li><li>合理适用子查询，比如in与exist，有时比连表效率更高</li><li>sql语句尽量简单（这个我的使用习惯），一些操作可以让应用层完成</li><li>聚合操作避免使用ICP（也就是聚合操作的extra列不要出现using index condition）</li><li>or</li><li>null</li><li>避免使用not in,而用not exists 替代</li></ol><h2 id="icp-index-condition-pushdown" tabindex="-1"><a class="header-anchor" href="#icp-index-condition-pushdown" aria-hidden="true">#</a> ICP(Index Condition PushDown)</h2><p><a href="https://www.jb51.net/article/222444.htm" target="_blank" rel="noopener noreferrer">https://www.jb51.net/article/222444.htm<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h2 id="mysql执行计划" tabindex="-1"><a class="header-anchor" href="#mysql执行计划" aria-hidden="true">#</a> MySQL执行计划</h2><p><a href="https://blog.csdn.net/horses/article/details/106905110" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/horses/article/details/106905110<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h2 id="小表驱动大表" tabindex="-1"><a class="header-anchor" href="#小表驱动大表" aria-hidden="true">#</a> 小表驱动大表</h2><h3 id="何为小表驱动大表" tabindex="-1"><a class="header-anchor" href="#何为小表驱动大表" aria-hidden="true">#</a> 何为小表驱动大表</h3><p>用小的数据集驱动大的数据集</p><h3 id="如何区分驱动表与被驱动表" tabindex="-1"><a class="header-anchor" href="#如何区分驱动表与被驱动表" aria-hidden="true">#</a> 如何区分驱动表与被驱动表</h3><p>很简单：explain 出来的结果中，第一行显示的表即为驱动表</p><h3 id="join的时候谁是驱动表" tabindex="-1"><a class="header-anchor" href="#join的时候谁是驱动表" aria-hidden="true">#</a> join的时候谁是驱动表</h3><ol><li>A left join B，则左表是驱动表，即A是驱动表</li><li>A right join B，则右表是驱动表，即B是驱动表</li><li>A inner join B，MySQL会选择比较小的表为驱动表</li></ol><h3 id="exsit与in" tabindex="-1"><a class="header-anchor" href="#exsit与in" aria-hidden="true">#</a> Exsit与In</h3><p>现在有两张表：</p><p>dept表：部门表，大概20条记录</p><p>emp表：员工表，大概1W条记录</p><p>需求：找出部门名称包含&quot;技术&quot;两个字的所有员工信息</p><p>方案一： select * from emp A where A.depNo in (select B.deptNo from dept B where <a href="http://B.name" target="_blank" rel="noopener noreferrer">B.name<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> like &#39;%技术%&#39;);</p><p>方案二： select * from emp A where exists ( select 1 from dept B where B.deptNo = A.deptNo and <a href="http://B.name" target="_blank" rel="noopener noreferrer">B.name<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> like &#39;%技术%&#39; )</p><p>先说结论：</p><ol><li>当A表的数据集大于B表时，IN比exists更优</li><li>当A表的数据集小于B表时，exists比IN更优</li></ol><p>根据上面的结论，可知方案一比方案二时间更短，不信可自行实验</p><blockquote><p><a href="https://mp.weixin.qq.com/s/KpTG1WUlcP6cyk8Y9SMcyQ" target="_blank" rel="noopener noreferrer">https://mp.weixin.qq.com/s/KpTG1WUlcP6cyk8Y9SMcyQ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a><a href="https://blog.csdn.net/qq_38011415/article/details/103304189" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/qq_38011415/article/details/103304189<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></blockquote><h2 id="哪些情况会出现全表扫描" tabindex="-1"><a class="header-anchor" href="#哪些情况会出现全表扫描" aria-hidden="true">#</a> 哪些情况会出现全表扫描</h2><ul><li>数据量太小了，走索引可能成本还要高一些</li><li>筛选列没有索引</li><li>筛选列有索引，但是匹配的数据量接近于整张表数据</li><li>筛选列有索引，但是使用方式不对，比如对列进行计算、不满足最左匹配原则</li><li><a href="https://blog.csdn.net/horses/article/details/107243447" target="_blank" rel="noopener noreferrer">有索引，但字符集不同<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><h3 id="in-和-exist语句" tabindex="-1"><a class="header-anchor" href="#in-和-exist语句" aria-hidden="true">#</a> IN 和 EXIST语句</h3><p><a href="https://mp.weixin.qq.com/s/KpTG1WUlcP6cyk8Y9SMcyQ" target="_blank" rel="noopener noreferrer">in和exist的选择<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h2 id="use-index-与-force-index的区别" tabindex="-1"><a class="header-anchor" href="#use-index-与-force-index的区别" aria-hidden="true">#</a> use index 与 force index的区别？</h2><p>use index是告诉优化器可以使用这个索引，但最终优化器可以不用这个索引。</p><p>force index是强制让优化器使用这个索引</p><h2 id="show-index-from-库名-表名" tabindex="-1"><a class="header-anchor" href="#show-index-from-库名-表名" aria-hidden="true">#</a> show index from 库名.表名</h2><p>这条命令输出了一个关键值：cardinality，表示该索引中唯一值的数目。这个值和表总行数应该尽量接近1，否则可以考虑是否可以删除这个索引。但这个值不是实时更新的，只是一个大概值。如果要手动更新这个值，可以使用 analyze table table_name来完成。</p><p>mysql是通过采样的方法来进行统计这个值的</p><p>优化器会根据这个值来判断是否使用这个索引，但这个值可能有时候不准确，因此可能影响sql执行性能，所以可以考虑在系统非高峰时间对核心表执行analyze table操作。</p><h2 id="实际例子" tabindex="-1"><a class="header-anchor" href="#实际例子" aria-hidden="true">#</a> 实际例子</h2><ul><li>MySQL的大部分索引（PRIMARY KEY,UNIQUE,INDEX）都采用的是B-Tree数据结构</li><li>对于一些特定的数据类型，会采用R-Tree数据结构</li><li>内存表（MEMORY table）支持 哈希表 数据结构</li><li>组合索引，复合索引，联合索引，是一个东西 <ul><li>对多个列建立一个索引，如下的组合索引。</li><li>要根据业务场景来决定列的顺序。</li><li>是否能用到联合索引，要看where条件是否符合 <em><strong>最左前缀</strong></em> 原则。</li><li>组合索引的第一个字段必须出现在查询组句中，这个索引才会被用到。（和上一条一个意思）</li></ul><div class="language-mysql line-numbers-mode" data-ext="mysql"><pre class="language-mysql"><code>create table test(
    a int,
    b int,
    c int,
    KEY a(a,b,c)
);

优: select * from test where a=10 and b&gt;50
差: select * from test where a50

优: select * from test order by a
差: select * from test order by b
差: select * from test order by c

优: select * from test where a=10 order by a
优: select * from test where a=10 order by b
差: select * from test where a=10 order by c

优: select * from test where a&gt;10 order by a
差: select * from test where a&gt;10 order by b
差: select * from test where a&gt;10 order by c

优: select * from test where a=10 and b=10 order by a
优: select * from test where a=10 and b=10 order by b
优: select * from test where a=10 and b=10 order by c

优: select * from test where a=10 and b=10 order by a
优: select * from test where a=10 and b&gt;10 order by b
差: select * from test where a=10 and b&gt;10 order by c



create table pqs_temp (
  a BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY ,
  b VARCHAR(50) DEFAULT &#39;&#39; not NULL ,
  c VARCHAR(50) DEFAULT &#39;&#39; not NULL ,
  d VARCHAR(50) DEFAULT &#39;&#39; not NULL ,
  e VARCHAR(50) DEFAULT &#39;&#39; NOT NULL
 );

alter TABLE pqs_temp add index b_c_d (b(20),c,d);  //索引包含的索引列的 部分信息

-- d 在索引中（没有用到覆盖索引）
EXPLAIN select d from pqs_temp where b = &#39;1&#39;;
mysql&gt; EXPLAIN select d from pqs_temp where b = &#39;1&#39;;
+----+-------------+----------+------+---------------+-------+---------+-------+------+-------------+
| id | select_type | table    | type | possible_keys | key   | key_len | ref   | rows | Extra       |
+----+-------------+----------+------+---------------+-------+---------+-------+------+-------------+
|  1 | SIMPLE      | pqs_temp | ref  | b_c_d         | b_c_d | 82      | const |   35 | Using where |
+----+-------------+----------+------+---------------+-------+---------+-------+------+-------------+


alter TABLE pqs_temp drop INDEX b_c_d;
ALTER TABLE pqs_temp add INDEX b_c_d (b,c,d);   //索引包含的索引列的 全部信息
-- d 在索引中（用到覆盖索引）什么叫 覆盖索引，下面有讲到。
EXPLAIN select d from pqs_temp where b = &#39;1&#39;;
+----+-------------+----------+------+---------------+-------+---------+-------+------+--------------------------+
| id | select_type | table    | type | possible_keys | key   | key_len | ref   | rows | Extra                    |
+----+-------------+----------+------+---------------+-------+---------+-------+------+--------------------------+
|  1 | SIMPLE      | pqs_temp | ref  | b_c_d         | b_c_d | 202     | const |   35 | Using where; Using index |
+----+-------------+----------+------+---------------+-------+---------+-------+------+--------------------------+  



alter TABLE pqs_temp drop INDEX b_c_d;
ALTER TABLE pqs_temp add INDEX b_c_d (b(20),c,d);
-- e 不在索引中
EXPLAIN select e from pqs_temp where b = &#39;1&#39;;
mysql&gt; EXPLAIN select e from pqs_temp where b = &#39;1&#39;;
+----+-------------+----------+------+---------------+-------+---------+-------+------+-------------+
| id | select_type | table    | type | possible_keys | key   | key_len | ref   | rows | Extra       |
+----+-------------+----------+------+---------------+-------+---------+-------+------+-------------+
|  1 | SIMPLE      | pqs_temp | ref  | b_c_d         | b_c_d | 82      | const |   35 | Using where |
+----+-------------+----------+------+---------------+-------+---------+-------+------+-------------+



alter TABLE pqs_temp drop INDEX b_c_d;
ALTER TABLE pqs_temp add INDEX b_c_d (b,c,d);
-- e 不在索引中
EXPLAIN select e from pqs_temp where b = &#39;1&#39;;
mysql&gt; EXPLAIN select e from pqs_temp where b = &#39;1&#39;;
+----+-------------+----------+------+---------------+-------+---------+-------+------+-----------------------+
| id | select_type | table    | type | possible_keys | key   | key_len | ref   | rows | Extra                 |
+----+-------------+----------+------+---------------+-------+---------+-------+------+-----------------------+
|  1 | SIMPLE      | pqs_temp | ref  | b_c_d         | b_c_d | 202     | const |    1 | Using index condition |
+----+-------------+----------+------+---------------+-------+---------+-------+------+-----------------------+ 



alter TABLE pqs_temp drop INDEX b_c_d;
ALTER TABLE pqs_temp add INDEX b_c_d (b(20),c,d);
-- * 中有不在索引中的列
EXPLAIN select * from pqs_temp where b = &#39;1&#39;;
mysql&gt; EXPLAIN select * from pqs_temp where b = &#39;1&#39;;
+----+-------------+----------+------+---------------+-------+---------+-------+------+-------------+
| id | select_type | table    | type | possible_keys | key   | key_len | ref   | rows | Extra       |
+----+-------------+----------+------+---------------+-------+---------+-------+------+-------------+
|  1 | SIMPLE      | pqs_temp | ref  | b_c_d         | b_c_d | 82      | const |   35 | Using where |
+----+-------------+----------+------+---------------+-------+---------+-------+------+-------------+



alter TABLE pqs_temp drop INDEX b_c_d;
ALTER TABLE pqs_temp add INDEX b_c_d (b,c,d);
-- * 中有不在索引中的列
EXPLAIN select * from pqs_temp where b = &#39;1&#39;;
mysql&gt; EXPLAIN select * from pqs_temp where b = &#39;1&#39;;
+----+-------------+----------+------+---------------+-------+---------+-------+------+-----------------------+
| id | select_type | table    | type | possible_keys | key   | key_len | ref   | rows | Extra                 |
+----+-------------+----------+------+---------------+-------+---------+-------+------+-----------------------+
|  1 | SIMPLE      | pqs_temp | ref  | b_c_d         | b_c_d | 202     | const |    1 | Using index condition |
+----+-------------+----------+------+---------------+-------+---------+-------+------+-----------------------+ 


-- order by 的列 不在索引中
EXPLAIN select * from pqs_temp where b = &#39;1&#39; ORDER BY e;
mysql&gt; EXPLAIN select * from pqs_temp where b = &#39;1&#39; ORDER BY e;
+----+-------------+----------+------+---------------+-------+---------+-------+------+-----------------------------+
| id | select_type | table    | type | possible_keys | key   | key_len | ref   | rows | Extra                       |
+----+-------------+----------+------+---------------+-------+---------+-------+------+-----------------------------+
|  1 | SIMPLE      | pqs_temp | ref  | b_c_d         | b_c_d | 82      | const |   35 | Using where; Using filesort |
+----+-------------+----------+------+---------------+-------+---------+-------+------+-----------------------------+


-- order by 的列 在索引中,但order by 的时候不能用到索引,因为不满足 最左优先 原则
EXPLAIN select * from pqs_temp where b = &#39;1&#39; ORDER BY d;
mysql&gt; EXPLAIN select * from pqs_temp where b = &#39;1&#39; ORDER BY d;
+----+-------------+----------+------+---------------+-------+---------+-------+------+-----------------------------+
| id | select_type | table    | type | possible_keys | key   | key_len | ref   | rows | Extra                       |
+----+-------------+----------+------+---------------+-------+---------+-------+------+-----------------------------+
|  1 | SIMPLE      | pqs_temp | ref  | b_c_d         | b_c_d | 82      | const |   35 | Using where; Using filesort |
+----+-------------+----------+------+---------------+-------+---------+-------+------+-----------------------------+


-- order by 的列 在索引中,同时order by 也能用到索引.因为满足 最左优先 原则
EXPLAIN select * from pqs_temp where b = &#39;1&#39; ORDER BY c;
mysql&gt; EXPLAIN select * from pqs_temp where b = &#39;1&#39; ORDER BY c;
+----+-------------+----------+------+---------------+-------+---------+-------+------+-------------+
| id | select_type | table    | type | possible_keys | key   | key_len | ref   | rows | Extra       |
+----+-------------+----------+------+---------------+-------+---------+-------+------+-------------+
|  1 | SIMPLE      | pqs_temp | ref  | b_c_d         | b_c_d | 82      | const |   35 | Using where |
+----+-------------+----------+------+---------------+-------+---------+-------+------+-------------+
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li>覆盖索引 <ul><li>如果一个select语句，select的字段都在这个sql使用的索引中，那么这种查询就走了覆盖索引。</li><li>可以说覆盖索引不是一种索引，而是索引的一种使用方法。</li><li>覆盖索引是针对具体的sql语句而言。同样的索引结构，不同的sql语句不一定就都走了 覆盖索引。</li><li>在EXPLAIN的Extra列出现Using Index提示时，就说明该select查询使用了覆盖索引。</li><li>要使用覆盖索引，至少满足下列条件 <ol><li>所用到的索引必须能覆盖相关索引列的全部数据</li><li>select的字段必须是索引中的字段</li></ol></li></ul></li><li>索引注意事项 <ul><li>应尽量避免对索引列进行频繁更新，因为每次更新索引列，对应的索引也需要更新，这样就降低的更新性能</li><li>每张表建立的所以也不能太多，因为每次插入删除数据的时候，都相应的增加，删除索引，所以一定程度上就会降低性能。</li></ul></li></ul><ol start="18"><li><p>添加索引</p><div class="language-mysql line-numbers-mode" data-ext="mysql"><pre class="language-mysql"><code>ALTER TABLE pqs_temp MODIFY COLUMN a BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT;
ALTER TABLE pqs_temp ADD PRIMARY KEY (a);

//唯一索引
ALTER TABLE pqs_temp ADD UNIQUE (b);

//联合唯一索引
alter TABLE pqs_temp add UNIQUE f_g (f,g);

//单列索引
ALTER TABLE pqs_temp ADD INDEX (c);

//组合索引
alter TABLE pqs_temp add INDEX b_c_d (b,c,d);
alter TABLE pqs_temp add INDEX b_c_d (b(20),c,d);//只将b列的前20个字符加入到索引的计算中

//全文索引
ALTER TABLE pqs_temp ADD FULLTEXT (d);

//貌似不能创建 hash 结构的索引
ALTER TABLE  pqs_temp add INDEX i USING HASH (i);  //可以执行成功，但通过show index from pqs_temp 查看索引，仍然显示index_type为btree.
+----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| Table    | Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |
+----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| pqs_temp |          0 | PRIMARY  |            1 | a           | A         |           2 |     NULL | NULL   |      | BTREE      |         |               |
| pqs_temp |          1 | i        |            1 | i           | A         |           1 |     NULL | NULL   |      | BTREE      |         |               |
+----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>查看表索引</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>show index from table_name;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>limit子句影响到了MySQL对索引的选择（这个真奇葩）</p><div class="language-mysql line-numbers-mode" data-ext="mysql"><pre class="language-mysql"><code>explain
SELECT *, usermessage.createTime AS mes
FROM usermessage
WHERE (
  (
    usermessage.uid = 101838
  )
  AND (
    usermessage.messageType = &#39;notice&#39; OR
    usermessage.messageType = &#39;im&#39;
  )
) ORDER BY msgId limit 50 ;

+----+-------------+-------------+-------+-----------------+------+---------+------+----------+------------------------------------+
| id | select_type | table       | type  | possible_keys   | key  | key_len | ref  | rows     | Extra                              |
+----+-------------+-------------+-------+-----------------+------+---------+------+----------+------------------------------------+
|  1 | SIMPLE      | usermessage | range | uid,messageType | uid  | 8       | NULL | 12106562 | Using index condition; Using where |
+----+-------------+-------------+-------+-----------------+------+---------+------+----------+------------------------------------+ 




explain
SELECT
  *,
  usermessage.createTime AS mes
FROM usermessage
WHERE (
  (
    usermessage.uid = 101838
  )
  AND (
    usermessage.messageType = &#39;notice&#39; OR
    usermessage.messageType = &#39;im&#39;
  )
) ORDER BY msgId DESC limit 50;

+----+-------------+-------------+-------+-----------------+------+---------+------+----------+------------------------------------+
| id | select_type | table       | type  | possible_keys   | key  | key_len | ref  | rows     | Extra                              |
+----+-------------+-------------+-------+-----------------+------+---------+------+----------+------------------------------------+
|  1 | SIMPLE      | usermessage | range | uid,messageType | uid  | 8       | NULL | 11726940 | Using index condition; Using where |
+----+-------------+-------------+-------+-----------------+------+---------+------+----------+------------------------------------+       





explain
SELECT
  *,
  usermessage.createTime AS mes
FROM usermessage
WHERE (
  (
    usermessage.uid = 101838
  )
  AND (
    usermessage.messageType = &#39;notice&#39; OR
    usermessage.messageType = &#39;im&#39;
  )
) ORDER BY msgId DESC;

+----+-------------+-------------+-------+-----------------+-------------+---------+------+------+----------------------------------------------------+
| id | select_type | table       | type  | possible_keys   | key         | key_len | ref  | rows | Extra                                              |
+----+-------------+-------------+-------+-----------------+-------------+---------+------+------+----------------------------------------------------+
|  1 | SIMPLE      | usermessage | range | uid,messageType | messageType | 50      | NULL |  402 | Using index condition; Using where; Using filesort |
+----+-------------+-------------+-------+-----------------+-------------+---------+------+------+----------------------------------------------------+  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>union操作会去重</p></li></ol><ul><li>MySQL在UNION去重时，只是比对两条数据的值是否相同，并不去判断值的数据类型是否一致，只要两条数据的每一列数值相等，就认为是重复的数据，UNION出来的结果只会一条.</li></ul><ol start="22"><li>指定sql结果集顺序：order by field(字段名,字段的值[逗号隔开])</li></ol><div class="language-mysql line-numbers-mode" data-ext="mysql"><pre class="language-mysql"><code>SELECT
  post.postId,
  post.createTime,
  post.commentNumber,
  post.likeNumber,
  post.postText,
  post.cityName,
  post.locationAddress,
  postimg.bigUrl,
  postimg.smallUrl,
  postimg.width,
  postimg.height
FROM post
  LEFT JOIN postimg ON postimg.imgId = post.postImgId
WHERE post.postId in (1,2) ORDER BY field(post.postId, 1,2)
LIMIT 10;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="23"><li>Join</li></ol><ul><li>join:两个集合的交集， 等价于 inner join</li><li>cross join:两个集合的笛卡尔积，返回的记录数为两个表的记录数乘积</li><li>A left join B:返回的记录数为A的记录数</li><li>B right join A == A left join B</li></ul><ol start="24"><li>SQL优化实战</li></ol><ul><li>case 1 : 分页获取粉丝列表<div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code># 索引结构:following root@localhost:fotoplacedb216:39:21&gt;show index from following;
+-----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| Table | Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null |
Index_type | Comment | Index_comment |
+-----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| following | 0 | PRIMARY | 1 | followingId | A | 59980091 | NULL | NULL | | BTREE | | | | following | 1 | uid1 | 1 |
uid1 | A | 3748755 | NULL | NULL | | BTREE | | | | following | 1 | uid2 | 1 | uid2 | A | 19993363 | NULL | NULL | |
BTREE | | |
+-----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+

  # 索引结构:user
  root@localhost:fotoplacedb216:40:21&gt;show index from user;
  +-------+------------+-----------------+--------------+-----------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
  | Table | Non_unique | Key_name        | Seq_in_index | Column_name     | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |
  +-------+------------+-----------------+--------------+-----------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
  | user  |          0 | PRIMARY         |            1 | uid             | A         |    24321834 |     NULL | NULL   |      | BTREE      |         |               |
  | user  |          0 | email           |            1 | email           | A         |    24321834 |     NULL | NULL   |      | BTREE      |         |               |
  | user  |          1 | isRecommended   |            1 | isRecommended   | A         |        1044 |     NULL | NULL   |      | BTREE      |         |               |
  | user  |          1 | isDefaultFollow |            1 | isDefaultFollow | A         |           2 |     NULL | NULL   |      | BTREE      |         |               |
  | user  |          1 | telephoneStr    |            1 | telephoneStr    | A         |     8107278 |     NULL | NULL   |      | BTREE      |         |               |
  | user  |          1 | likeNumber      |            1 | likeNumber      | A         |       10611 |     NULL | NULL   |      | BTREE      |         |               |
  | user  |          1 | latlngidx       |            1 | lat             | A         |    24321834 |     NULL | NULL   |      | BTREE      |         |               |
  | user  |          1 | latlngidx       |            2 | lng             | A         |    24321834 |     NULL | NULL   |      | BTREE      |         |               |
  | user  |          1 | idx_ctime       |            1 | createTime      | A         |    24321834 |     NULL | NULL   | YES  | BTREE      |         |               |
  | user  |          1 | pass_idx        |            1 | password        | A         |    12160917 |     NULL | NULL   |      | BTREE      |         |               |
  | user  |          1 | ostype_idx      |            1 | OSType          | A         |      149213 |     NULL | NULL   |      | BTREE      |         |               |
  | user  |          1 | ltime           |            1 | lastUpdateTime  | A         |    24321834 |     NULL | NULL   | YES  | BTREE      |         |               |
  +-------+------------+-----------------+--------------+-----------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
  12 rows in set (0.00 sec)                                                                           
  
  
  # 原始Sql:7.03s
  root@localhost:fotoplacedb216:21:46&gt;SELECT
  -&gt;   following.followingId,
  -&gt;   user.uid,
  -&gt;   user.userName,
  -&gt;   user.signature,
  -&gt;   user.avatar,
  -&gt;   user.lat,
  -&gt;   user.lng
  -&gt; FROM following
  -&gt;   INNER JOIN user ON following.uid2 = user.uid
  -&gt; WHERE following.uid1 = 101838
  -&gt; ORDER BY following.followingId DESC
  -&gt; LIMIT 2000000, 15;
  +-------------+----------+-----------------------+-----------+-------------------------------------------------------------+------------+------------+
  | followingId | uid      | userName              | signature | avatar                                                      | lat        | lng        |
  +-------------+----------+-----------------------+-----------+-------------------------------------------------------------+------------+------------+
  |    63041171 | 23301217 | 浅沫记忆              |           | /static/img/common/avatar.png                               | 0.00000000 | 0.00000000 |
  |    63041168 | 23301216 | 港岛妹妹              |           | http://dn.fotoplace.cc/9031e9b5433e4aa7a0640c39579684f7.jpg | 0.00000000 | 0.00000000 |
  |    63041166 | 23301212 | 陈透明                |           | /static/img/common/avatar.png                               | 0.00000000 | 0.00000000 |
  |    63041161 | 23301215 | 趺苏                  |           | http://dn.fotoplace.cc/1a6b8ac82b6c41a49f8325b9cf6735c4.jpg | 0.00000000 | 0.00000000 |
  |    63041158 | 23301214 | Gareth_Bale11         |           | /53a081e3fe6549248a096dd6b81f77ee.jpg                       | 0.00000000 | 0.00000000 |
  |    63041156 | 23301213 | 老宋                  |           | http://dn.fotoplace.cc/bd0419c95b4a4cf284c4301755d44722.jpg | 0.00000000 | 0.00000000 |
  |    63041151 | 23301211 | 唯爱敏                |           | http://dn.fotoplace.cc/f6d8e31029b945338cff2fa059609612.jpg | 0.00000000 | 0.00000000 |
  |    63041146 | 23301209 | LVenus                |           | http://dn.fotoplace.cc/a9d2eec4719d4af19d3c9f702a9f2149.jpg | 0.00000000 | 0.00000000 |
  |    63041138 | 23301207 | 呐个谁伱不配          |           | http://dn.fotoplace.cc/0dce2ae1cfb048e5b4420d9795e21e57.jpg | 0.00000000 | 0.00000000 |
  |    63041134 | 23301206 | 懒先森                |           | http://dn.fotoplace.cc/8873bda0cbbb4a7b9772b4e962ad7c4d.jpg | 0.00000000 | 0.00000000 |
  |    63041130 | 23301205 | 刘艺                  |           | http://dn.fotoplace.cc/7db76a45455f4d92b03659b643b3759c.jpg | 0.00000000 | 0.00000000 |
  |    63041128 | 23301203 | 搅拌雨水的尘埃        |           | http://dn.fotoplace.cc/a6fd183dee2843b88704e8459d28820c.jpg | 0.00000000 | 0.00000000 |
  |    63041124 | 23301202 | NotFoundError         |           | /6aa98a013dcd47f2a49449b78c54722a.jpg                       | 0.00000000 | 0.00000000 |
  |    63041122 | 23301201 | Ruin彡                |           | http://dn.fotoplace.cc/13d94a3080644af5bb1bfde03cd0f3ad.jpg | 0.00000000 | 0.00000000 |
  |    63041120 | 23301200 | 马兰花                |           | http://dn.fotoplace.cc/07b6ee1ee1c9468193a01cb30480739c.jpg | 0.00000000 | 0.00000000 |
  +-------------+----------+-----------------------+-----------+-------------------------------------------------------------+------------+------------+
  15 rows in set (7.03 sec)                       
  
  # 优化第一次:2.55s
  root@localhost:fotoplacedb216:24:58&gt;SELECT
  -&gt;   following.followingId,
  -&gt;   user.uid,
  -&gt;   user.userName,
  -&gt;   user.signature,
  -&gt;   user.avatar,
  -&gt;   user.lat,
  -&gt;   user.lng
  -&gt; FROM following
  -&gt;   INNER JOIN user ON following.uid2 = user.uid
  -&gt; WHERE following.uid1 = 101838 AND following.followingId &lt; 63041172
  -&gt; ORDER BY following.followingId DESC
  -&gt; LIMIT 15;
  +-------------+----------+-----------------------+-----------+-------------------------------------------------------------+------------+------------+
  | followingId | uid      | userName              | signature | avatar                                                      | lat        | lng        |
  +-------------+----------+-----------------------+-----------+-------------------------------------------------------------+------------+------------+
  |    63041171 | 23301217 | 浅沫记忆              |           | /static/img/common/avatar.png                               | 0.00000000 | 0.00000000 |
  |    63041168 | 23301216 | 港岛妹妹              |           | http://dn.fotoplace.cc/9031e9b5433e4aa7a0640c39579684f7.jpg | 0.00000000 | 0.00000000 |
  |    63041166 | 23301212 | 陈透明                |           | /static/img/common/avatar.png                               | 0.00000000 | 0.00000000 |
  |    63041161 | 23301215 | 趺苏                  |           | http://dn.fotoplace.cc/1a6b8ac82b6c41a49f8325b9cf6735c4.jpg | 0.00000000 | 0.00000000 |
  |    63041158 | 23301214 | Gareth_Bale11         |           | /53a081e3fe6549248a096dd6b81f77ee.jpg                       | 0.00000000 | 0.00000000 |
  |    63041156 | 23301213 | 老宋                  |           | http://dn.fotoplace.cc/bd0419c95b4a4cf284c4301755d44722.jpg | 0.00000000 | 0.00000000 |
  |    63041151 | 23301211 | 唯爱敏                |           | http://dn.fotoplace.cc/f6d8e31029b945338cff2fa059609612.jpg | 0.00000000 | 0.00000000 |
  |    63041146 | 23301209 | LVenus                |           | http://dn.fotoplace.cc/a9d2eec4719d4af19d3c9f702a9f2149.jpg | 0.00000000 | 0.00000000 |
  |    63041138 | 23301207 | 呐个谁伱不配          |           | http://dn.fotoplace.cc/0dce2ae1cfb048e5b4420d9795e21e57.jpg | 0.00000000 | 0.00000000 |
  |    63041134 | 23301206 | 懒先森                |           | http://dn.fotoplace.cc/8873bda0cbbb4a7b9772b4e962ad7c4d.jpg | 0.00000000 | 0.00000000 |
  |    63041130 | 23301205 | 刘艺                  |           | http://dn.fotoplace.cc/7db76a45455f4d92b03659b643b3759c.jpg | 0.00000000 | 0.00000000 |
  |    63041128 | 23301203 | 搅拌雨水的尘埃        |           | http://dn.fotoplace.cc/a6fd183dee2843b88704e8459d28820c.jpg | 0.00000000 | 0.00000000 |
  |    63041124 | 23301202 | NotFoundError         |           | /6aa98a013dcd47f2a49449b78c54722a.jpg                       | 0.00000000 | 0.00000000 |
  |    63041122 | 23301201 | Ruin彡                |           | http://dn.fotoplace.cc/13d94a3080644af5bb1bfde03cd0f3ad.jpg | 0.00000000 | 0.00000000 |
  |    63041120 | 23301200 | 马兰花                |           | http://dn.fotoplace.cc/07b6ee1ee1c9468193a01cb30480739c.jpg | 0.00000000 | 0.00000000 |
  +-------------+----------+-----------------------+-----------+-------------------------------------------------------------+------------+------------+
  15 rows in set (2.55 sec)  
  
  # 优化第二次:0.01s
  root@localhost:fotoplacedb216:30:58&gt;SELECT
  -&gt;   followingId,
  -&gt;   user.uid,
  -&gt;   user.userName,
  -&gt;   user.signature,
  -&gt;   user.avatar,
  -&gt;   user.lat,
  -&gt;   user.lng
  -&gt; FROM user,
  -&gt;   (
  -&gt;     SELECT
  -&gt;       uid2,
  -&gt;       followingId
  -&gt;     FROM following
  -&gt;     USE INDEX (`PRIMARY`)
  -&gt;     WHERE uid1 = 101838 AND followingId &lt; 63041172
  -&gt;     ORDER BY followingId DESC
  -&gt;     LIMIT 15
  -&gt;   ) AS a
  -&gt; WHERE a.uid2 = user.uid ORDER BY followingId desc;
  +-------------+----------+-----------------------+-----------+-------------------------------------------------------------+------------+------------+
  | followingId | uid      | userName              | signature | avatar                                                      | lat        | lng        |
  +-------------+----------+-----------------------+-----------+-------------------------------------------------------------+------------+------------+
  |    63041171 | 23301217 | 浅沫记忆              |           | /static/img/common/avatar.png                               | 0.00000000 | 0.00000000 |
  |    63041168 | 23301216 | 港岛妹妹              |           | http://dn.fotoplace.cc/9031e9b5433e4aa7a0640c39579684f7.jpg | 0.00000000 | 0.00000000 |
  |    63041166 | 23301212 | 陈透明                |           | /static/img/common/avatar.png                               | 0.00000000 | 0.00000000 |
  |    63041161 | 23301215 | 趺苏                  |           | http://dn.fotoplace.cc/1a6b8ac82b6c41a49f8325b9cf6735c4.jpg | 0.00000000 | 0.00000000 |
  |    63041158 | 23301214 | Gareth_Bale11         |           | /53a081e3fe6549248a096dd6b81f77ee.jpg                       | 0.00000000 | 0.00000000 |
  |    63041156 | 23301213 | 老宋                  |           | http://dn.fotoplace.cc/bd0419c95b4a4cf284c4301755d44722.jpg | 0.00000000 | 0.00000000 |
  |    63041151 | 23301211 | 唯爱敏                |           | http://dn.fotoplace.cc/f6d8e31029b945338cff2fa059609612.jpg | 0.00000000 | 0.00000000 |
  |    63041146 | 23301209 | LVenus                |           | http://dn.fotoplace.cc/a9d2eec4719d4af19d3c9f702a9f2149.jpg | 0.00000000 | 0.00000000 |
  |    63041138 | 23301207 | 呐个谁伱不配          |           | http://dn.fotoplace.cc/0dce2ae1cfb048e5b4420d9795e21e57.jpg | 0.00000000 | 0.00000000 |
  |    63041134 | 23301206 | 懒先森                |           | http://dn.fotoplace.cc/8873bda0cbbb4a7b9772b4e962ad7c4d.jpg | 0.00000000 | 0.00000000 |
  |    63041130 | 23301205 | 刘艺                  |           | http://dn.fotoplace.cc/7db76a45455f4d92b03659b643b3759c.jpg | 0.00000000 | 0.00000000 |
  |    63041128 | 23301203 | 搅拌雨水的尘埃        |           | http://dn.fotoplace.cc/a6fd183dee2843b88704e8459d28820c.jpg | 0.00000000 | 0.00000000 |
  |    63041124 | 23301202 | NotFoundError         |           | /6aa98a013dcd47f2a49449b78c54722a.jpg                       | 0.00000000 | 0.00000000 |
  |    63041122 | 23301201 | Ruin彡                |           | http://dn.fotoplace.cc/13d94a3080644af5bb1bfde03cd0f3ad.jpg | 0.00000000 | 0.00000000 |
  +-------------+----------+-----------------------+-----------+-------------------------------------------------------------+------------+------------+
  14 rows in set (0.01 sec) 
  这里少返回一条数据，是因为删除user表数据时没有删除following表的关联数据，导致following中存在无效数据。
  如果不删除following表中的关联数据，极端情况下上条sql可能返回 empty set。
  
  # expalin 对比
  三个sql语句的explain结果一次如下：
  +----+-------------+-----------+--------+---------------+---------+---------+-----------------------------+----------+-------------+
  | id | select_type | table     | type   | possible_keys | key     | key_len | ref                         | rows     | Extra       |
  +----+-------------+-----------+--------+---------------+---------+---------+-----------------------------+----------+-------------+
  |  1 | SIMPLE      | following | ref    | uid1,uid2     | uid1    | 8       | const                       | 15359220 | Using where |
  |  1 | SIMPLE      | user      | eq_ref | PRIMARY       | PRIMARY | 8       | fotoplacedb2.following.uid2 |        1 | NULL        |
  +----+-------------+-----------+--------+---------------+---------+---------+-----------------------------+----------+-------------+ 
  
  +----+-------------+-----------+--------+-------------------+---------+---------+-----------------------------+---------+-------------+
  | id | select_type | table     | type   | possible_keys     | key     | key_len | ref                         | rows    | Extra       |
  +----+-------------+-----------+--------+-------------------+---------+---------+-----------------------------+---------+-------------+
  |  1 | SIMPLE      | following | ref    | PRIMARY,uid1,uid2 | uid1    | 8       | const                       | 6850308 | Using where |
  |  1 | SIMPLE      | user      | eq_ref | PRIMARY           | PRIMARY | 8       | fotoplacedb2.following.uid2 |       1 | NULL        |
  +----+-------------+-----------+--------+-------------------+---------+---------+-----------------------------+---------+-------------+ 
  
  +----+-------------+------------+--------+---------------+---------+---------+--------+----------+----------------+
  | id | select_type | table      | type   | possible_keys | key     | key_len | ref    | rows     | Extra          |
  +----+-------------+------------+--------+---------------+---------+---------+--------+----------+----------------+
  |  1 | PRIMARY     | &lt;derived2&gt; | ALL    | NULL          | NULL    | NULL    | NULL   |       15 | Using filesort |
  |  1 | PRIMARY     | user       | eq_ref | PRIMARY       | PRIMARY | 8       | a.uid2 |        1 | NULL           |
  |  2 | DERIVED     | following  | range  | PRIMARY       | PRIMARY | 8       | NULL   | 29990072 | Using where    |
  +----+-------------+------------+--------+---------------+---------+---------+--------+----------+----------------+  
  
  # SQL分析
      第一条sql:
          1. 用offset来分页，大数据量下不可取
          2. 获取某一页A数据后，如果产生了新的数据（新的粉丝），在获取A的下一页数据时，会返回重复数据。
      
      优化方案：采用断点方式分页。（这里的断点就是followingId字段）

  # 断点分页注意事项：
      1. 断点字段在表中必须唯一，否则可能漏掉数据或返回重复数据（比如时间类型的字段）
      2. 断点字段必须有建立索引（为了快速定位目标数据），排序字段如果不方便可以不用建立索引，但前提是返回结果集的数量小的情况下才可以不用建立索引。
      3. 根据实际场景优化索引结构，比如上面的最后一条SQL，由于where中用到了uid1和followingId两个字段，可以对这两个字段建立联合索引(uid1,followingId)，在优化的话可以考虑到select字段，让select的字段也在索引中。
      
  # 奇怪的事来了，接着往下看
  root@localhost:fotoplacedb217:43:19&gt;SELECT
  -&gt;   followingId,
  -&gt;   user.uid,
  -&gt;   user.userName,
  -&gt;   user.signature,
  -&gt;   user.avatar
  -&gt; FROM user,
  -&gt;   (
  -&gt;     SELECT
  -&gt;       uid2,
  -&gt;       followingId
  -&gt;     FROM following
  -&gt;       use index (`PRIMARY`)
  -&gt;     WHERE uid1 = 101838 AND followingId &lt; 63041172
  -&gt;     ORDER BY followingId DESC
  -&gt;     LIMIT 20
  -&gt;   ) AS a
  -&gt; WHERE a.uid2 = user.uid
  -&gt; ORDER BY followingId DESC
  -&gt; LIMIT 15;
  
  数据省了
  
  15 rows in set (0.00 sec)         
  
  这个秒回，任意改变followingId的值，也是秒回（其实也不是，当followingId为20000000的时候，需要2.65s，而30000000，20000000的时候都小于2.65s，可以近似的说20000000是个峰值，followingId离20000000越近，时间越长，越远，时间越短。这里先不讨论这个问题，就当做是秒回）
  
  换为另外一个用户，并获取第一页数据
  root@localhost:fotoplacedb217:58:45&gt;SELECT
  -&gt;   followingId,
  -&gt;   user.uid,
  -&gt;   user.userName,
  -&gt;   user.signature,
  -&gt;   user.avatar
  -&gt; FROM user,
  -&gt;   (
  -&gt;     SELECT
  -&gt;       uid2,
  -&gt;       followingId
  -&gt;     FROM following
  -&gt;     use index (`PRIMARY`)
  -&gt;     WHERE uid1 = 23640407 AND followingId &lt; 999999999999
  -&gt;     ORDER BY followingId DESC
  -&gt;     LIMIT 20
  -&gt;   ) AS a
  -&gt; WHERE a.uid2 = user.uid
  -&gt; ORDER BY followingId DESC
  -&gt; LIMIT 15;
  
  数据省了
  
  15 rows in set (0.58 sec)
  
  这里竟然用了0.58s。换做101838用户获取任意页数据都是秒回。
  101838 用户是大V用户，粉丝大约有600w。 
  23640407 用户是普通用户（就是本宝宝），粉丝就40个。
  如果不强制使用主键索引，那么普通用户的数据就是秒回。
  
  总结如下：
  如果强制使用主键索引，大V用户拉取任意页数据可以认为是秒回。普通用户拉取数据却会变慢.
  如果不强制使用索引，大V用户越往后拉数据，速度会变慢（也不是百分百递增，下面说这个问题）。普通用户就是秒回。
  
  本宝宝搞不懂了。😢
  
  由于系统大部分用户还是像我一样的普通用户，然后即便是大V用户，也很少拉后面的数据。所以本宝宝决定不强制使用主键索引了。
  
  
  现在试验不强制使用索引的情况：
  普通用户不用试验，有雨数据量小，都是秒回（真正的秒回）
  试验大V用户发现：
  root@localhost:fotoplacedb218:18:13&gt;SELECT
  -&gt;   followingId,
  -&gt;   user.uid,
  -&gt;   user.userName,
  -&gt;   user.signature,
  -&gt;   user.avatar
  -&gt; FROM user,
  -&gt;   (
  -&gt;     SELECT
  -&gt;       uid2,
  -&gt;       followingId
  -&gt;     FROM following
  -&gt;     WHERE uid1 = 101838 AND followingId &lt; 60000000
  -&gt;     ORDER BY followingId DESC
  -&gt;     LIMIT 20
  -&gt;   ) AS a
  -&gt; WHERE a.uid2 = user.uid
  -&gt; ORDER BY followingId DESC
  -&gt; LIMIT 15;
  
  数据省了
  
  15 rows in set (3.90 sec)    
  
  可以近似认为 followingId 为 6000w 时，速度最慢。followingId离6000w越近，越慢，越远，越快。
  其实这就引出两个问题：
      1. 为什么存在这样一个峰值？
      2. 为什么使用索引和不使用索引，两个峰值不一样?
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>redis			3.0.5
mysql			5.6.26-log	          
	主：16个cpu(每个cpu一个核)      32G内存
	从：16个cpu(每个cpu一个核)      32G内存
	备份：4个cpu(每个cpu一个核)     4G 内存               
zookeeper   	3.4.6
dubbo-admin  	2.5.3
es				1.6.0-2.1.0
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><br><br><br><br><br><br></p><hr><hr><ul><li><strong>随机毒鸡汤</strong>：所谓复习就是，把不会的东西再确认一遍，我—确实不会。 <br><br><img src="https://api.btstu.cn/sjbz/?lx=suiji&amp;uuid=c70cca6a-23e0-4317-9cda-25fff20af036" alt="" loading="lazy"></li></ul></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/rocky-peng/rocky-peng.github.io/edit/main/src/software/middleware/mysql/SQL优化.md" rel="noopener noreferrer" target="_blank" aria-label="在 GitHub 上编辑此页" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->在 GitHub 上编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><!----></div></footer><nav class="page-nav"><a href="/software/middleware/mysql/MySQL%E9%94%81%E3%80%81%E4%BA%8B%E5%8A%A1%E3%80%81%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB.html" class="nav-link prev" aria-label="MySQL锁、事务、隔离级别"><div class="hint"><span class="arrow start"></span>上一页</div><div class="link"><FontIcon></FontIcon>MySQL锁、事务、隔离级别</div></a><a href="/software/middleware/mysql/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1Seata.html" class="nav-link next" aria-label="分布式事务Seata"><div class="hint">下一页<span class="arrow end"></span></div><div class="link">分布式事务Seata<FontIcon></FontIcon></div></a></nav><div class="giscus-wrapper input-top" id="comment" style="display:block;"><div class="loading-icon-wrapper" style="display:flex;align-items:center;justify-content:center;height:96px"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" preserveAspectRatio="xMidYMid" viewBox="25 25 50 50"><animateTransform attributeName="transform" type="rotate" dur="2s" keyTimes="0;1" repeatCount="indefinite" values="0;360"></animateTransform><circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-dasharray" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="1,200;90,200;1,200"></animate><animate attributeName="stroke-dashoffset" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="0;-35px;-125px"></animate></circle></svg></div></div><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer"><a href="https://justsoso.fun" target="_blank">技术加油站</a>&nbsp;|&nbsp;<a href="/sitemap.xml" target="_blank">站点地图</a>&nbsp;|&nbsp;本站总访问量<span id="busuanzi_value_site_pv"></span>次&nbsp;|&nbsp;本文总访问量<span id="busuanzi_value_page_pv"></span>次&nbsp;|&nbsp;本站总访客数<span id="busuanzi_value_site_uv"></span>人<!-- <a href="https://beian.miit.gov.cn/" target="_blank">渝ICP备2022014544号-1</a> --><!--&nbsp;|&nbsp; <a href="http://leyongjituan.com">乐用集团</a>--></div><div class="copyright">Copyright © 2024 技术加油站</div></footer></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app-4845962f.js" defer></script>
  </body>
</html>
